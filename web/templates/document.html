<div class="document-page">
    <nav class="breadcrumb">
        <a href="/dashboard">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            Dashboard
        </a>
        <span>/</span>
        <a href="/project/{{project_uuid}}">{{project_name}}</a>
        <span>/</span>
        <span>{{document_name}}</span>
    </nav>
    
    <div class="page-header">
        <div>
            <h1>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5;">
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                {{document_name}}
            </h1>
        </div>
        <div class="actions" style="display:flex;align-items:center;gap:12px;">
            <div class="doc-viewer-presence" id="doc-viewer-presence" title="Currently viewing"></div>
            {{#if can_edit}}
            <a href="/editor/{{document_uuid}}" class="btn btn-primary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Edit Document
            </a>
            {{/if}}
        </div>
    </div>
    
    <article class="markdown-body doc-content">
        {{content}}
    </article>
</div>

<style>
.document-page .page-header h1 {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.document-page .doc-content {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    max-width: 100%;
    animation: fadeIn 0.3s ease;
}

/* Viewer presence chips (shared style) */
.doc-viewer-presence {
    display: flex;
    align-items: center;
    gap: 4px;
}
.viewer-chip {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: var(--primary-color);
    color: #fff;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    cursor: default;
    border: 2px solid var(--card-bg);
    box-sizing: content-box;
    transition: transform 0.1s ease;
}
.viewer-chip:hover { transform: scale(1.15); }
.viewer-chip:nth-child(2) { background: #10b981; }
.viewer-chip:nth-child(3) { background: #f59e0b; }
.viewer-chip:nth-child(4) { background: #ef4444; }
.viewer-chip:nth-child(5) { background: #8b5cf6; }
.viewer-chip-more {
    font-size: 0.7rem;
    color: var(--text-muted);
    padding: 0 4px;
    white-space: nowrap;
}
</style>

<script>
(function() {
    const DOC_UUID     = '{{document_uuid}}';
    const CURRENT_USER = '{{username}}';
    const presenceEl   = document.getElementById('doc-viewer-presence');

    // Ping & poll
    async function ping() {
        try { await fetch('/api/documents/' + DOC_UUID + '/ping', {method:'POST'}); } catch(_){}
    }
    async function pollViewers() {
        try {
            const r = await fetch('/api/documents/' + DOC_UUID + '/viewers');
            if (!r.ok) return;
            const data = await r.json();
            const others = (data.viewers || []).filter(v => v.username !== CURRENT_USER);
            renderChips(others);
        } catch(_){}
    }
    function renderChips(viewers) {
        if (!viewers.length) { presenceEl.innerHTML = ''; return; }
        const max = 4, extra = viewers.length - max;
        let html = viewers.slice(0, max).map(v =>
            `<span class="viewer-chip" title="${v.username}">${v.username.charAt(0).toUpperCase()}</span>`
        ).join('');
        if (extra > 0) html += `<span class="viewer-chip-more">+${extra}</span>`;
        presenceEl.innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Syntax highlight code blocks (server-rendered)
        document.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));

        ping();
        pollViewers();
        setInterval(ping,         15000);
        setInterval(pollViewers,  5000);
    });
})();
</script>

