<!-- View-mode CDN dependencies (same as editor) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.5.0/github-markdown.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked-highlight/lib/index.umd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/morphdom@2.7.2/dist/morphdom-umd.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<div class="document-page">
    <nav class="breadcrumb">
        <a href="/dashboard">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            Dashboard
        </a>
        <span>/</span>
        <a href="/project/{{project_uuid}}">{{project_name}}</a>
        <span>/</span>
        <span>{{document_name}}</span>
    </nav>

    <div class="doc-header">
        <h1 class="doc-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.5;flex-shrink:0">
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            {{document_name}}
        </h1>
        <div class="doc-actions">
            <div class="doc-viewer-presence" id="doc-viewer-presence" title="Currently viewing"></div>

            <!-- Download dropdown -->
            <div class="act-dropdown" id="dl-dropdown">
                <button class="btn" onclick="toggleActDropdown('dl-dropdown')">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"/><path d="M7.25 7.689V2a.75.75 0 0 1 1.5 0v5.689l1.97-1.969a.749.749 0 1 1 1.06 1.06l-3.25 3.25a.749.749 0 0 1-1.06 0L4.22 6.78a.749.749 0 1 1 1.06-1.06l1.97 1.969Z"/></svg>
                    Download
                    <svg width="10" height="10" viewBox="0 0 16 16" fill="currentColor" style="opacity:.6"><path d="M4.427 7.427l3.396 3.396a.25.25 0 0 0 .354 0l3.396-3.396A.25.25 0 0 0 11.396 7H4.604a.25.25 0 0 0-.177.427Z"/></svg>
                </button>
                <div class="act-dropdown-menu" id="dl-dropdown-menu">
                    <button class="act-dropdown-item" onclick="downloadMd()">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M14.85 3c.63 0 1.15.52 1.14 1.15v7.7c0 .63-.51 1.15-1.15 1.15H1.15C.52 13 0 12.48 0 11.84V4.15C0 3.52.52 3 1.15 3ZM9 11V5H7L5.5 7 4 5H2v6h2V8l1.5 1.92L7 8v3Zm2.99.5L14.5 8H13V5h-2v3H9.5Z"/></svg>
                        Markdown (.md)
                    </button>
                    <button class="act-dropdown-item" onclick="downloadHtml()">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M4.708 5.578L2.061 8.224l2.647 2.646-.708.708-3-3V7.87l3-3 .708.708zm7.292 5.354l2.647-2.646-2.647-2.646.708-.708 3 3v.708l-3 3-.708-.708zM6.417 11.646l2.5-8 .833.417-2.5 8-.833-.417z"/></svg>
                        HTML (.html)
                    </button>
                    <button class="act-dropdown-item" onclick="downloadPdf()">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M3.75 1.5a.25.25 0 0 0-.25.25v11.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25V6H9.75A1.75 1.75 0 0 1 8 4.25V1.5Zm5.75.56v2.19c0 .138.112.25.25.25h2.19Zm-7.25-2.06A1.75 1.75 0 0 1 4 1.75v-.56A1.75 1.75 0 0 1 5.75 0h5.086c.464 0 .909.184 1.237.513l3.414 3.414c.329.328.513.773.513 1.237v8.086A1.75 1.75 0 0 1 14.25 15H1.75A1.75 1.75 0 0 1 0 13.25V3.75A1.75 1.75 0 0 1 1.75 1.75h.5Z"/></svg>
                        PDF (.pdf)
                    </button>
                </div>
            </div>

            {{#if can_edit}}
            <a href="/editor/{{document_uuid}}" class="btn btn-primary">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Edit
            </a>
            {{/if}}
        </div>
    </div>

    <div class="doc-body">
        <nav class="toc-sidebar" id="toc-sidebar">
            <div class="toc-header">Contents</div>
            <ul class="toc-list" id="toc-list"></ul>
        </nav>
        <div id="doc-content" class="markdown-body preview-scroll doc-content">
            <div class="doc-loading">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="spin" style="opacity:.4"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                Loading&#8230;
            </div>
        </div>
    </div>
</div>

<style>
/* Lock the outer page — only .doc-content scrolls */
html, body { overflow: hidden; }
main.container { padding: 0; height: calc(100vh - 64px); overflow: hidden; }

/* ── Page layout ─────────────────────────────────────────────── */
.document-page {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 64px);
    padding: var(--spacing-md) var(--spacing-xl) 0;
    box-sizing: border-box;
    overflow: hidden;
}
.document-page .breadcrumb { flex-shrink: 0; margin-bottom: 4px; }

.doc-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0 8px;
    flex-shrink: 0;
    gap: var(--spacing-md);
}
.doc-title {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.doc-actions {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    flex-shrink: 0;
}

.doc-body {
    flex: 1;
    display: flex;
    gap: 0;
    min-height: 0;
    border: 1px solid var(--card-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: var(--card-bg);
    box-shadow: var(--card-shadow);
    margin-bottom: var(--spacing-md);
}

.doc-content {
    flex: 1;
    overflow-y: auto;
    padding: 28px 36px;
    min-width: 0;
    background: transparent !important;
    color: var(--text-color) !important;
    font-family: var(--font-sans) !important;
    font-size: 15px;
    line-height: 1.7;
}

.doc-loading {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 40px;
    color: var(--text-muted);
    font-size: 0.9rem;
}

@keyframes spin { to { transform: rotate(360deg); } }
.spin { animation: spin 1s linear infinite; }

/* ── TOC (same as editor) ─────────────────────────────────────── */
.toc-sidebar {
    width: 210px;
    min-width: 210px;
    background: var(--divider);
    border-right: 1px solid var(--border-color);
    overflow-y: auto;
    padding: 14px 0;
    flex-shrink: 0;
    display: none;
}
.toc-sidebar.has-headings { display: block; }
.toc-header { padding: 0 14px 10px; font-size: .68rem; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; color: var(--text-muted); border-bottom: 1px solid var(--border-color); margin-bottom: 6px; }
.toc-list { list-style: none; margin: 0; padding: 0; }
.toc-list li { margin: 0; }
.toc-list a { display: block; padding: 5px 14px; font-size: .78rem; color: var(--text-muted); text-decoration: none; border-left: 2px solid transparent; transition: all .12s ease; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.toc-list a:hover  { color: var(--text-color); background: var(--hover-bg); }
.toc-list a.active { color: var(--primary-color); border-left-color: var(--primary-color); background: var(--hover-bg); }
.toc-list .toc-h1 { padding-left: 14px; font-weight: 600; }
.toc-list .toc-h2 { padding-left: 14px; font-weight: 500; }
.toc-list .toc-h3 { padding-left: 26px; }
.toc-list .toc-h4 { padding-left: 38px; font-size: .72rem; }
.toc-list .toc-h5 { padding-left: 50px; font-size: .72rem; }
.toc-list .toc-h6 { padding-left: 62px; font-size: .72rem; }

/* ── Viewer presence chips ───────────────────────────────────── */
.doc-viewer-presence { display: flex; align-items: center; gap: 4px; }
.viewer-chip { display: inline-flex; align-items: center; justify-content: center; width: 26px; height: 26px; border-radius: 50%; background: var(--primary-color); color: #fff; font-size: .65rem; font-weight: 700; text-transform: uppercase; cursor: default; border: 2px solid var(--card-bg); box-sizing: content-box; transition: transform .1s ease; }
.viewer-chip:hover { transform: scale(1.15); }
.viewer-chip:nth-child(2) { background: #10b981; }
.viewer-chip:nth-child(3) { background: #f59e0b; }
.viewer-chip:nth-child(4) { background: #ef4444; }
.viewer-chip:nth-child(5) { background: #8b5cf6; }
.viewer-chip-more { font-size: .7rem; color: var(--text-muted); padding: 0 4px; white-space: nowrap; }

/* ── Download dropdown ───────────────────────────────────────── */
.act-dropdown { position: relative; }
.act-dropdown-menu { display: none; position: absolute; top: calc(100% + 6px); right: 0; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--radius-md); box-shadow: 0 8px 32px rgba(0,0,0,.35); z-index: 400; min-width: 170px; overflow: hidden; }
.act-dropdown-menu.open { display: block; }
.act-dropdown-item { display: flex; align-items: center; gap: 8px; width: 100%; padding: 9px 14px; background: none; border: none; text-align: left; font-size: .82rem; color: var(--text-secondary); cursor: pointer; transition: background .1s, color .1s; font-family: inherit; }
.act-dropdown-item:hover { background: var(--hover-bg); color: var(--text-color); }

/* ── Markdown body overrides (same as editor) ─────────────────── */
.doc-content.markdown-body { background: transparent !important; color: var(--text-color) !important; }
.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6 { color: var(--text-color) !important; border-bottom-color: var(--border-color) !important; }
.markdown-body blockquote { border-left-color: var(--border-color) !important; color: var(--text-secondary) !important; }
.markdown-body table tr { background: var(--card-bg) !important; border-top-color: var(--border-color) !important; }
.markdown-body table tr:nth-child(2n) { background: var(--divider) !important; }
.markdown-body table th,.markdown-body table td { border-color: var(--border-color) !important; }
.markdown-body hr { background: var(--border-color) !important; }
.markdown-body a { color: var(--primary-color) !important; }
.markdown-body img { max-width: 100%; border-radius: 6px; border: 1px solid var(--border-color); }

/* ── Code blocks ─────────────────────────────────────────────── */
.markdown-body pre { position: relative; background: var(--input-bg,#1e1e1e) !important; border: 1px solid var(--border-color) !important; border-radius: 8px !important; padding: 0 !important; overflow: hidden; margin: 16px 0; }
.code-copy-btn { position: absolute; top: 8px; right: 8px; padding: 3px 8px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-muted); font-size: 11px; cursor: pointer; opacity: 0; transition: opacity .15s; z-index: 1; font-family: inherit; }
.markdown-body pre:hover .code-copy-btn { opacity: 1; }
.code-copy-btn:hover { background: var(--border-color); color: var(--text-color); }
.code-copy-btn.copied { color: var(--success-color,#10b981); }
.markdown-body pre code { display: block; padding: 14px 16px !important; overflow-x: auto; background: transparent !important; font-size: 13px; line-height: 1.55; }
.markdown-body code { background: var(--divider) !important; color: var(--text-color) !important; padding: 2px 6px; border-radius: 4px; font-size: .9em; }
.code-line { display: block; }
.line-number { display: inline-block; width: 3em; padding-right: 1em; text-align: right; color: var(--text-muted); user-select: none; opacity: .45; font-size: 12px; }
.line-content { display: inline; }

/* ── Mermaid ─────────────────────────────────────────────────── */
.mermaid { background: var(--divider); border-radius: 8px; padding: 16px; margin: 16px 0; text-align: center; overflow-x: auto; }
.mermaid-error { color: #ef4444; font-size: .8rem; padding: 8px; text-align: center; }

/* ── Plots ───────────────────────────────────────────────────── */
.plot-container { margin: 16px 0; border-radius: 8px; overflow: visible; }
.plot-error { color: #ef4444; font-size: .82rem; padding: 12px 16px; background: rgba(239,68,68,.1); border-radius: 8px; margin: 16px 0; border: 1px solid rgba(239,68,68,.2); }

/* ── Callouts ────────────────────────────────────────────────── */
.callout { padding: 12px 16px; margin: 16px 0; border-radius: 8px; border-left: 4px solid; background: var(--divider); }
.callout-title { display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px; font-size: .9rem; }
.callout-title svg,.callout-title .callout-icon { width: 16px; height: 16px; flex-shrink: 0; }
.callout-content p:last-child { margin-bottom: 0; }
.callout-note,.callout-info     { border-left-color: #3b82f6; } .callout-note .callout-title,.callout-info .callout-title         { color: #3b82f6; }
.callout-tip,.callout-success   { border-left-color: #10b981; } .callout-tip .callout-title,.callout-success .callout-title       { color: #10b981; }
.callout-warning,.callout-question { border-left-color: #f59e0b; } .callout-warning .callout-title,.callout-question .callout-title { color: #f59e0b; }
.callout-danger,.callout-error,.callout-bug,.callout-failure { border-left-color: #ef4444; }
.callout-danger .callout-title,.callout-error .callout-title,.callout-bug .callout-title,.callout-failure .callout-title { color: #ef4444; }
.callout-important,.callout-example { border-left-color: #8b5cf6; } .callout-important .callout-title,.callout-example .callout-title { color: #8b5cf6; }
.callout-quote,.callout-abstract { border-left-color: #64748b; } .callout-quote .callout-title,.callout-abstract .callout-title { color: #94a3b8; }

/* ── Highlights / math / task-lists / kbd / tabs ─────────────── */
mark { background: rgba(245,158,11,.3); color: var(--text-color); padding: 1px 3px; border-radius: 2px; }
.math-block  { margin: 20px 0; padding: 16px; text-align: center; overflow-x: auto; }
.math-inline { display: inline; }
.math-error  { color: #ef4444; font-family: var(--font-mono); font-size: 12px; }
.katex-display { margin: 0 !important; }
.markdown-body .task-list-item { list-style-type: none; }
.markdown-body .task-list-item input[type="checkbox"] { margin-right: 8px; accent-color: var(--primary-color); }
kbd { display: inline-flex; align-items: center; justify-content: center; font-family: var(--font-mono); font-size: .75em; padding: 2px 6px; background: var(--divider); border: 1px solid var(--border-color); border-bottom-width: 2px; border-radius: 4px; color: var(--text-color); white-space: nowrap; }
.kbd-combo { display: inline-flex; align-items: center; gap: 2px; }
.kbd-sep { color: var(--text-muted); font-size: .75em; padding: 0 1px; }
.tab-group { margin: 16px 0; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
.tab-buttons { display: flex; background: var(--divider); border-bottom: 1px solid var(--border-color); overflow-x: auto; }
.tab-btn { padding: 8px 16px; background: none; border: none; border-bottom: 2px solid transparent; color: var(--text-muted); font-size: .82rem; font-weight: 500; cursor: pointer; white-space: nowrap; transition: color .15s, border-color .15s; font-family: inherit; }
.tab-btn:hover { color: var(--text-color); }
.tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
.tab-content { display: none; padding: 0; }
.tab-content.active { display: block; }
.tab-content > *:first-child { margin-top: 0 !important; }
.tab-content > *:last-child  { margin-bottom: 0 !important; }
.tab-content pre { border-radius: 0 !important; border: none !important; margin: 0 !important; }

@media (max-width: 768px) {
    .document-page { padding: var(--spacing-sm); }
    .toc-sidebar { display: none !important; }
    .act-dropdown-menu { right: auto; left: 0; }
}
</style>

<script>
(function () {
'use strict';

const DOC_UUID     = '{{document_uuid}}';
const DOC_NAME     = '{{document_name}}';
const CURRENT_USER = '{{username}}';

const contentEl  = document.getElementById('doc-content');
const tocSidebar = document.getElementById('toc-sidebar');
const tocList    = document.getElementById('toc-list');
const presenceEl = document.getElementById('doc-viewer-presence');

let rawMarkdown   = '';
let mermaidLoaded = false;
let plotlyLoaded  = false;

/* ── Viewer presence ─────────────────────────────────────────── */
async function ping() {
    try { await fetch('/api/documents/' + DOC_UUID + '/ping', { method: 'POST' }); } catch(_) {}
}
async function pollViewers() {
    try {
        const r = await fetch('/api/documents/' + DOC_UUID + '/viewers');
        if (!r.ok) return;
        const data = await r.json();
        const others = (data.viewers || []).filter(v => v.username !== CURRENT_USER);
        if (!others.length) { presenceEl.innerHTML = ''; return; }
        const max = 4, extra = others.length - max;
        let html = others.slice(0, max).map(v =>
            `<span class="viewer-chip" title="${v.username}">${v.username.charAt(0).toUpperCase()}</span>`
        ).join('');
        if (extra > 0) html += `<span class="viewer-chip-more">+${extra}</span>`;
        presenceEl.innerHTML = html;
    } catch(_) {}
}

/* ── Download dropdown ───────────────────────────────────────── */
window.toggleActDropdown = function(id) {
    const menu = document.getElementById(id + '-menu');
    if (!menu) return;
    const open = menu.classList.contains('open');
    document.querySelectorAll('.act-dropdown-menu.open').forEach(m => m.classList.remove('open'));
    if (!open) menu.classList.add('open');
};
document.addEventListener('click', e => {
    if (!e.target.closest('.act-dropdown'))
        document.querySelectorAll('.act-dropdown-menu.open').forEach(m => m.classList.remove('open'));
});
window.downloadMd = function() {
    document.querySelectorAll('.act-dropdown-menu.open').forEach(m => m.classList.remove('open'));
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([rawMarkdown], { type: 'text/markdown;charset=utf-8' }));
    a.download = DOC_NAME + '.md';
    a.click();
    URL.revokeObjectURL(a.href);
};
window.downloadHtml = function() {
    document.querySelectorAll('.act-dropdown-menu.open').forEach(m => m.classList.remove('open'));
    const html = `<!DOCTYPE html>\n<html>\n<head><meta charset="UTF-8"><title>${DOC_NAME}</title></head>\n<body>\n${contentEl.innerHTML}\n</body>\n</html>`;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([html], { type: 'text/html;charset=utf-8' }));
    a.download = DOC_NAME + '.html';
    a.click();
    URL.revokeObjectURL(a.href);
};
window.downloadPdf = function() {
    document.querySelectorAll('.act-dropdown-menu.open').forEach(m => m.classList.remove('open'));
    if (typeof html2pdf === 'undefined') { alert('PDF library not loaded'); return; }
    const filename = DOC_NAME.replace(/\.md$/i, '') + '.pdf';
    // Probe to get the fully-resolved card background
    const probe = document.createElement('div');
    probe.style.cssText = 'position:fixed;width:1px;height:1px;opacity:0;pointer-events:none;background:var(--card-bg)';
    document.body.appendChild(probe);
    const bgColor = getComputedStyle(probe).backgroundColor;
    document.body.removeChild(probe);
    // Override any !important transparent rules with !important inline
    contentEl.style.setProperty('background', bgColor, 'important');
    const opt = {
        margin:      0,
        filename:    filename,
        image:       { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, logging: false, backgroundColor: bgColor },
        jsPDF:       { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(contentEl).save()
        .then(() => { contentEl.style.removeProperty('background'); })
        .catch(() => { contentEl.style.removeProperty('background'); });
};

/* ── Tab groups ──────────────────────────────────────────────── */
window.activateTab = function(id) {
    const content = document.getElementById(id);
    if (!content) return;
    const group = content.closest('.tab-group');
    if (!group) return;
    group.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === id));
    group.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === id));
};

/* ── Pre-processing (identical to editor) ────────────────────── */
function protectCodeBlocks(src, fn) {
    const saved = [];
    const out = src.replace(/```[\s\S]*?```|`[^`\n]+`/g, m => { saved.push(m); return '\x00BLOCK' + (saved.length - 1) + '\x00'; });
    const result = fn(out);
    return result.replace(/\x00BLOCK(\d+)\x00/g, (_, i) => saved[+i]);
}
function preHighlights(src) {
    return protectCodeBlocks(src, s => s.replace(/==([^=\n]+)==/g, '<mark>$1</mark>'));
}
function preMath(src) {
    return protectCodeBlocks(src, s => {
        s = s.replace(/\$\$([\s\S]+?)\$\$/g, (_, m) => `<div class="math-block" data-math="${encodeURIComponent(m.trim())}"></div>`);
        s = s.replace(/(?<!\$)\$(?!\$)([^$\n]+?)(?<!\$)\$(?!\$)/g, (_, m) => `<span class="math-inline" data-math="${encodeURIComponent(m.trim())}"></span>`);
        return s;
    });
}
const CALLOUT_ICONS = {
    note:     '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>',
    tip:      '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"/></svg>',
    warning:  '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>',
    danger:   '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>',
    error:    '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>',
    info:     '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>',
    important:'<svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>',
    success:  '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"/></svg>',
    question: '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.92 6.085h.001a.749.749 0 1 1-1.342-.67c.169-.339.436-.701.849-.977C6.845 4.16 7.369 4 8 4a2.756 2.756 0 0 1 1.637.525c.503.377.863.965.863 1.725 0 .448-.115.83-.329 1.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6.24 6.24 0 0 0-.26.16.952.952 0 0 0-.276.245.75.75 0 0 1-1.248-.832c.184-.264.42-.489.692-.661.103-.067.207-.132.313-.195l.007-.004c.1-.061.182-.11.258-.161a.969.969 0 0 0 .277-.245C8.96 6.514 9 6.427 9 6.25a.612.612 0 0 0-.262-.525A1.27 1.27 0 0 0 8 5.5c-.369 0-.595.09-.74.187a1.01 1.01 0 0 0-.34.398ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>',
    failure:  '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M2.343 13.657A8 8 0 1 1 13.658 2.343 8 8 0 0 1 2.343 13.657ZM6.03 4.97a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042L6.94 8 4.97 9.97a.749.749 0 0 0 .326 1.275.749.749 0 0 0 .734-.215L8 9.06l1.97 1.97a.749.749 0 0 0 1.275-.326.749.749 0 0 0-.215-.734L9.06 8l1.97-1.97a.749.749 0 0 0-.326-1.275.749.749 0 0 0-.734.215L8 6.94Z"/></svg>',
    bug:      '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M4.72.22a.749.749 0 0 1 1.06 0l.97.97.97-.97a.749.749 0 1 1 1.06 1.06l-.97.97.97.97a.749.749 0 0 1-1.06 1.06L6.75 3.28l-.97.97a.749.749 0 0 1-1.06-1.06l.97-.97-.97-.97a.749.749 0 0 1 0-1.06Z"/></svg>',
    example:  '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Zm7.251 10.324.004-5.073-.002-2.253A2.25 2.25 0 0 0 5.003 2.5H1.5v9h3.757a3.75 3.75 0 0 1 1.994.574ZM8.755 4.75l-.004 7.322a3.752 3.752 0 0 1 1.992-.572H14.5v-9h-3.495a2.25 2.25 0 0 0-2.25 2.25Z"/></svg>',
    quote:    '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M1.75 2h12.5c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0 1 14.25 14H1.75A1.75 1.75 0 0 1 0 12.25v-8.5C0 2.784.784 2 1.75 2ZM1.5 12.251c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V5.809L8.38 9.397a.75.75 0 0 1-.76 0L1.5 5.809v6.442Zm13-8.181v-.32a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25v.32L8 7.88Z"/></svg>',
    abstract: '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 1.75A.75.75 0 0 1 .75 1h4.253c1.227 0 2.317.59 3 1.501A3.743 3.743 0 0 1 11.006 1h4.245a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-.75.75h-4.507a2.25 2.25 0 0 0-1.591.659l-.622.621a.75.75 0 0 1-1.06 0l-.622-.621A2.25 2.25 0 0 0 5.258 13H.75a.75.75 0 0 1-.75-.75Zm7.251 10.324.004-5.073-.002-2.253A2.25 2.25 0 0 0 5.003 2.5H1.5v9h3.757a3.75 3.75 0 0 1 1.994.574ZM8.755 4.75l-.004 7.322a3.752 3.752 0 0 1 1.992-.572H14.5v-9h-3.495a2.25 2.25 0 0 0-2.25 2.25Z"/></svg>',
};
function preCallouts(src) {
    return protectCodeBlocks(src, s => s.replace(/^>\s*\[!(note|tip|warning|danger|error|info|important|success|question|failure|bug|example|quote|abstract)\]([^\n]*)\n((?:>[^\n]*\n?)*)/gim,
        (_, type, title, body) => {
            const t = type.toLowerCase();
            const icon = CALLOUT_ICONS[t] || CALLOUT_ICONS.note;
            const label = title.trim().replace(/^["']|["']$/g, '') || (t.charAt(0).toUpperCase() + t.slice(1));
            const clean = body.split('\n').map(l => l.replace(/^>\s?/, '')).join('\n').trim();
            return `<div class="callout callout-${t}"><div class="callout-title">${icon}${label}</div><div class="callout-content">\n\n${clean}\n\n</div></div>\n\n`;
        }));
}
function preContentTabs(src) {
    const lines = src.split('\n'), out = [];
    let i = 0;
    while (i < lines.length) {
        const m = lines[i].match(/^===\s*"([^"]+)"\s*$/);
        if (m) {
            const tabs = [];
            while (i < lines.length) {
                const tm = lines[i].match(/^===\s*"([^"]+)"\s*$/);
                if (!tm && tabs.length > 0) {
                    if (lines[i].startsWith('    ') || lines[i].startsWith('\t') || lines[i] === '') { tabs[tabs.length-1].lines.push(lines[i].replace(/^    |\t/, '')); i++; continue; }
                    else { break; }
                }
                if (tm) { tabs.push({ title: tm[1], lines: [] }); i++; continue; }
                break;
            }
            if (tabs.length > 0) {
                const gid = 'tg-' + Math.random().toString(36).slice(2, 8);
                const btns = tabs.map((t, idx) => `<button class="tab-btn${idx===0?' active':''}" data-tab="${gid}-${idx}" onclick="activateTab('${gid}-${idx}')">${t.title}</button>`).join('');
                const contents = tabs.map((t, idx) => `<div class="tab-content${idx===0?' active':''}" id="${gid}-${idx}">\n\n${t.lines.join('\n')}\n\n</div>`).join('\n');
                out.push(`<div class="tab-group"><div class="tab-buttons">${btns}</div>${contents}</div>`);
                continue;
            }
        }
        out.push(lines[i]); i++;
    }
    return out.join('\n');
}
function preKeyboardKeys(src) {
    return protectCodeBlocks(src, s => {
        s = s.replace(/\+\+([^+\n][^+\n]*?)\+\+/g, (_, keys) => {
            const parts = keys.split(/\+(?=[A-Z0-9])/);
            if (parts.length === 1) return `<kbd>${parts[0]}</kbd>`;
            return '<span class="kbd-combo">' + parts.map((p, i) => i === 0 ? `<kbd>${p}</kbd>` : `<span class="kbd-sep">+</span><kbd>${p}</kbd>`).join('') + '</span>';
        });
        s = s.replace(/\[\[([^\]\n]+?)\]\]/g, (_, keys) => {
            const parts = keys.split('+');
            if (parts.length === 1) return `<kbd>${parts[0]}</kbd>`;
            return '<span class="kbd-combo">' + parts.map((p, i) => i === 0 ? `<kbd>${p}</kbd>` : `<span class="kbd-sep">+</span><kbd>${p}</kbd>`).join('') + '</span>';
        });
        return s;
    });
}

/* ── Marked setup ────────────────────────────────────────────── */
function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function initMarked() {
    if (typeof marked === 'undefined') return;
    if (typeof hljs !== 'undefined') {
        hljs.configure({ ignoreUnescapedHTML: true });
        if (!hljs.getLanguage('mermaid')) hljs.registerLanguage('mermaid', () => ({ name:'mermaid', contains:[] }));
        if (!hljs.getLanguage('plot'))    hljs.registerLanguage('plot',    () => ({ name:'plot',    contains:[] }));
    }
    if (typeof markedHighlight !== 'undefined' && typeof hljs !== 'undefined') {
        const hlFn = markedHighlight.markedHighlight || markedHighlight;
        marked.use(hlFn({
            langPrefix: 'hljs language-',
            highlight(code, lang) {
                if (lang === 'mermaid' || lang === 'plot') return code;
                let highlighted;
                if (lang && hljs.getLanguage(lang)) {
                    try { highlighted = hljs.highlight(code, { language: lang, ignoreIllegals: true }).value; }
                    catch { highlighted = escHtml(code); }
                } else { highlighted = escHtml(code); }
                const rawLines = code.split('\n'), hlLines = highlighted.split('\n');
                return rawLines.map((_, idx) =>
                    `<span class="code-line"><span class="line-number">${idx+1}</span><span class="line-content">${hlLines[idx]||''}</span></span>`
                ).join('');
            }
        }));
    }
    marked.setOptions({ breaks: true, gfm: true });
}

/* ── Post-processing ─────────────────────────────────────────── */
function postProcess(container) {
    container.querySelectorAll('pre code.language-mermaid').forEach(code => {
        const src = code.textContent.trim();
        const div = document.createElement('div');
        div.className = 'mermaid'; div.setAttribute('data-source', src); div.textContent = src;
        code.parentElement.replaceWith(div);
    });
    container.querySelectorAll('pre code.language-plot').forEach(code => {
        const src = code.textContent.trim();
        const div = document.createElement('div');
        div.className = 'plot-container'; div.setAttribute('data-source', src);
        code.parentElement.replaceWith(div);
    });
    container.querySelectorAll('pre').forEach(pre => {
        const btn = document.createElement('button');
        btn.className = 'code-copy-btn'; btn.textContent = 'Copy';
        btn.addEventListener('click', () => {
            const codeEl = pre.querySelector('code');
            if (!codeEl) return;
            const lc = codeEl.querySelectorAll('.line-content');
            const text = lc.length > 0 ? Array.from(lc).map(e => e.textContent).join('\n') : codeEl.textContent;
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'Copied!'; btn.classList.add('copied');
                setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
            });
        });
        pre.appendChild(btn);
    });
}

/* ── Math ────────────────────────────────────────────────────── */
function renderMath() {
    if (typeof katex === 'undefined') return;
    contentEl.querySelectorAll('.math-block:not([data-rendered])').forEach(el => {
        try { katex.render(decodeURIComponent(el.dataset.math), el, { displayMode: true, throwOnError: false }); el.dataset.rendered = '1'; }
        catch(e) { el.innerHTML = `<span class="math-error">${e.message}</span>`; }
    });
    contentEl.querySelectorAll('.math-inline:not([data-rendered])').forEach(el => {
        try { katex.render(decodeURIComponent(el.dataset.math), el, { displayMode: false, throwOnError: false }); el.dataset.rendered = '1'; }
        catch(e) { el.innerHTML = `<span class="math-error">${e.message}</span>`; }
    });
}

/* ── Mermaid ─────────────────────────────────────────────────── */
async function renderMermaid() {
    const divs = contentEl.querySelectorAll('.mermaid:not([data-processed])');
    if (!divs.length) return;
    if (!mermaidLoaded) {
        try {
            const m = await import('https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs');
            window._mermaid = m.default;
            window._mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'loose' });
            mermaidLoaded = true;
        } catch(e) { console.warn('Mermaid load failed', e); return; }
    }
    for (const div of divs) {
        const src = div.getAttribute('data-source') || div.textContent.trim();
        div.setAttribute('data-processed', '1');
        try {
            const id = 'md-' + Date.now() + '-' + Math.random().toString(36).slice(2, 6);
            const { svg } = await window._mermaid.render(id, src);
            div.innerHTML = svg;
        } catch(e) { div.innerHTML = `<div class="mermaid-error">Mermaid error: ${e.message}</div>`; }
    }
}

/* ── Plots ───────────────────────────────────────────────────── */
async function loadPlotly() {
    if (plotlyLoaded || typeof Plotly !== 'undefined') { plotlyLoaded = true; return; }
    await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = 'https://cdn.plot.ly/plotly-2.27.0.min.js';
        s.onload = resolve; s.onerror = reject;
        document.head.appendChild(s);
    });
    plotlyLoaded = true;
}
const PlotHelpers = {
    sin:Math.sin, cos:Math.cos, tan:Math.tan, asin:Math.asin, acos:Math.acos, atan:Math.atan, atan2:Math.atan2,
    sinh:Math.sinh, cosh:Math.cosh, tanh:Math.tanh,
    sqrt:Math.sqrt, abs:Math.abs, exp:Math.exp, log:Math.log, log10:Math.log10, log2:Math.log2,
    pow:Math.pow, floor:Math.floor, ceil:Math.ceil, round:Math.round,
    min:Math.min, max:Math.max, sign:Math.sign, random:Math.random,
    PI:Math.PI, E:Math.E,
    range(start, end, step=1) { const a=[]; for(let i=start;i<=end;i+=step) a.push(i); return a; },
    linspace(start, end, n=50) { const a=[],s=(end-start)/(n-1); for(let i=0;i<n;i++) a.push(start+i*s); return a; },
    meshgrid(x,y) { const X=[],Y=[]; for(let j=0;j<y.length;j++){X.push([...x]);Y.push(Array(x.length).fill(y[j]));} return{X,Y}; },
    // 2D helpers
    line(fn, xRange=[-10,10], opts={}) {
        const x=PlotHelpers.linspace(xRange[0],xRange[1],opts.resolution||200);
        return {type:'scatter',mode:'lines',x,y:x.map(v=>{try{const r=fn(v);return isFinite(r)?r:null;}catch{return null;}}),name:opts.name||'',line:{color:opts.color,width:opts.width||2}};
    },
    scatter(pts,opts={}) { return {type:'scatter',mode:opts.mode||'markers',x:pts.map(p=>p[0]),y:pts.map(p=>p[1]),name:opts.name||'',marker:{size:opts.size||8,color:opts.color||'#58a6ff'}}; },
    polyline(pts,opts={}) { return {type:'scatter',mode:'lines',x:pts.map(p=>p[0]),y:pts.map(p=>p[1]),name:opts.name||'',line:{color:opts.color,width:opts.width||2}}; },
    bar(labels,values,opts={}) { return {type:'bar',x:labels,y:values,name:opts.name||'',marker:{color:opts.color||'#58a6ff'}}; },
    parametric2d(fx,fy,tRange=[0,2*Math.PI],steps=200,opts={}) { const t=PlotHelpers.linspace(tRange[0],tRange[1],steps); return {type:'scatter',mode:'lines',x:t.map(fx),y:t.map(fy),name:opts.name||'',line:{color:opts.color,width:opts.width||2}}; },
    circle(r=1,c=[0,0],opts={}) { const t=PlotHelpers.linspace(0,2*Math.PI,opts.resolution||100); return {type:'scatter',mode:'lines',x:t.map(a=>c[0]+r*Math.cos(a)),y:t.map(a=>c[1]+r*Math.sin(a)),name:opts.name||'',fill:opts.fill?'toself':undefined,line:{color:opts.color,width:opts.width||2}}; },
    ellipse(a=2,b=1,c=[0,0],opts={}) { const t=PlotHelpers.linspace(0,2*Math.PI,opts.resolution||100); return {type:'scatter',mode:'lines',x:t.map(ang=>c[0]+a*Math.cos(ang)),y:t.map(ang=>c[1]+b*Math.sin(ang)),name:opts.name||'',fill:opts.fill?'toself':undefined,line:{color:opts.color,width:opts.width||2}}; },
    arc(r=1,sa=0,ea=Math.PI,c=[0,0],opts={}) { const t=PlotHelpers.linspace(sa,ea,opts.resolution||50); return {type:'scatter',mode:'lines',x:t.map(a=>c[0]+r*Math.cos(a)),y:t.map(a=>c[1]+r*Math.sin(a)),name:opts.name||'',line:{color:opts.color,width:opts.width||2}}; },
    rect(w=2,h=1,c=[0,0],opts={}) { const [cx,cy]=[c[0],c[1]],hw=w/2,hh=h/2; return {type:'scatter',mode:'lines',x:[cx-hw,cx+hw,cx+hw,cx-hw,cx-hw],y:[cy-hh,cy-hh,cy+hh,cy+hh,cy-hh],name:opts.name||'',fill:opts.fill?'toself':undefined,line:{color:opts.color,width:opts.width||2}}; },
    polygon(verts,opts={}) { const cl=[...verts,verts[0]]; return {type:'scatter',mode:'lines',x:cl.map(v=>v[0]),y:cl.map(v=>v[1]),name:opts.name||'',fill:opts.fill?'toself':undefined,line:{color:opts.color,width:opts.width||2}}; },
    arrow(s=[0,0],e=[1,1],opts={}) { const [x0,y0]=s,[x1,y1]=e,hs=opts.headSize||0.1,dx=x1-x0,dy=y1-y0,l=Math.sqrt(dx*dx+dy*dy),ux=dx/l,uy=dy/l; return {type:'scatter',mode:'lines',x:[x0,x1,null,x1,x1-hs*(ux+uy*.5),null,x1,x1-hs*(ux-uy*.5)],y:[y0,y1,null,y1,y1-hs*(uy-ux*.5),null,y1,y1-hs*(uy+ux*.5)],name:opts.name||'',line:{color:opts.color||'#f78166',width:opts.width||2}}; },
    pie(labels,values,opts={}) { return {type:'pie',labels,values,name:opts.name||'',hole:opts.hole||0}; },
    heatmap(z,opts={}) { return {type:'heatmap',z,x:opts.x,y:opts.y,colorscale:opts.colorscale||'Viridis',showscale:opts.showscale!==false}; },
    // 3D helpers
    surface(fn,xR=[-5,5],yR=[-5,5],res=50,opts={}) {
        const x=PlotHelpers.linspace(xR[0],xR[1],res),y=PlotHelpers.linspace(yR[0],yR[1],res),z=[];
        for(let j=0;j<y.length;j++){const row=[];for(let i=0;i<x.length;i++){try{const v=fn(x[i],y[j]);row.push(isFinite(v)?v:null);}catch{row.push(null);}}z.push(row);}
        return {type:'surface',x,y,z,colorscale:opts.colorscale||'Viridis',opacity:opts.opacity||1,showscale:opts.showscale!==false};
    },
    parametric(fx,fy,fz,tR=[0,2*Math.PI],steps=200,opts={}) { const t=PlotHelpers.linspace(tR[0],tR[1],steps); return {type:'scatter3d',mode:'lines',x:t.map(fx),y:t.map(fy),z:t.map(fz),name:opts.name||'',line:{width:opts.width||3,color:opts.color||'#f78166'}}; },
    parametricSurface(fx,fy,fz,uR=[0,2*Math.PI],vR=[0,Math.PI],res=30,opts={}) {
        const u=PlotHelpers.linspace(uR[0],uR[1],res),v=PlotHelpers.linspace(vR[0],vR[1],res),x=[],y=[],z=[];
        for(let j=0;j<v.length;j++){const xr=[],yr=[],zr=[];for(let i=0;i<u.length;i++){try{xr.push(fx(u[i],v[j]));yr.push(fy(u[i],v[j]));zr.push(fz(u[i],v[j]));}catch{xr.push(null);yr.push(null);zr.push(null);}}x.push(xr);y.push(yr);z.push(zr);}
        return {type:'surface',x,y,z,colorscale:opts.colorscale||'Viridis',opacity:opts.opacity||1,showscale:opts.showscale!==false};
    },
    sphere(r=1,c=[0,0,0],opts={}) { return PlotHelpers.parametricSurface((u,v)=>c[0]+r*Math.sin(v)*Math.cos(u),(u,v)=>c[1]+r*Math.sin(v)*Math.sin(u),(u,v)=>c[2]+r*Math.cos(v),[0,2*Math.PI],[0,Math.PI],opts.resolution||30,{colorscale:opts.colorscale||[[0,opts.color||'#1e90ff'],[1,opts.color||'#1e90ff']],opacity:opts.opacity||0.8,showscale:false}); },
    cylinder(r=1,h=2,c=[0,0,0],opts={}) {
        const res=opts.resolution||30,u=PlotHelpers.linspace(0,2*Math.PI,res),v=PlotHelpers.linspace(-h/2,h/2,res),x=[],y=[],z=[];
        for(let j=0;j<v.length;j++){const xr=[],yr=[],zr=[];for(let i=0;i<u.length;i++){xr.push(c[0]+r*Math.cos(u[i]));yr.push(c[1]+r*Math.sin(u[i]));zr.push(c[2]+v[j]);}x.push(xr);y.push(yr);z.push(zr);}
        return {type:'surface',x,y,z,colorscale:opts.colorscale||[[0,opts.color||'#2ecc71'],[1,opts.color||'#2ecc71']],opacity:opts.opacity||0.8,showscale:false};
    },
    cone(r=1,h=2,c=[0,0,0],opts={}) {
        const res=opts.resolution||30,u=PlotHelpers.linspace(0,2*Math.PI,res),v=PlotHelpers.linspace(0,1,res),x=[],y=[],z=[];
        for(let j=0;j<v.length;j++){const rr=r*(1-v[j]),xr=[],yr=[],zr=[];for(let i=0;i<u.length;i++){xr.push(c[0]+rr*Math.cos(u[i]));yr.push(c[1]+rr*Math.sin(u[i]));zr.push(c[2]+v[j]*h);}x.push(xr);y.push(yr);z.push(zr);}
        return {type:'surface',x,y,z,colorscale:opts.colorscale||[[0,opts.color||'#e74c3c'],[1,opts.color||'#e74c3c']],opacity:opts.opacity||0.8,showscale:false};
    },
    box(w=1,h=1,d=1,c=[0,0,0],opts={}) {
        const [cx,cy,cz]=c,hw=w/2,hh=h/2,hd=d/2,verts=[[cx-hw,cy-hh,cz-hd],[cx+hw,cy-hh,cz-hd],[cx+hw,cy+hh,cz-hd],[cx-hw,cy+hh,cz-hd],[cx-hw,cy-hh,cz+hd],[cx+hw,cy-hh,cz+hd],[cx+hw,cy+hh,cz+hd],[cx-hw,cy+hh,cz+hd]];
        return {type:'mesh3d',x:verts.map(v=>v[0]),y:verts.map(v=>v[1]),z:verts.map(v=>v[2]),i:[0,0,4,4,0,0,1,1,0,0,3,3],j:[1,2,5,6,1,4,2,5,3,4,2,6],k:[2,3,6,7,4,5,5,6,4,7,6,7],color:opts.color||'#9b59b6',opacity:opts.opacity||0.8};
    },
    torus(R=2,r=0.5,c=[0,0,0],opts={}) { return PlotHelpers.parametricSurface((u,v)=>c[0]+(R+r*Math.cos(v))*Math.cos(u),(u,v)=>c[1]+(R+r*Math.cos(v))*Math.sin(u),(u,v)=>c[2]+r*Math.sin(v),[0,2*Math.PI],[0,2*Math.PI],opts.resolution||30,{colorscale:opts.colorscale||'Viridis',opacity:opts.opacity||0.8,showscale:false}); },
    plane(w=4,h=4,c=[0,0,0],n=[0,0,1],opts={}) { const [cx,cy,cz]=c,hw=w/2,hh=h/2; return {type:'surface',x:[[cx-hw,cx+hw],[cx-hw,cx+hw]],y:[[cy-hh,cy-hh],[cy+hh,cy+hh]],z:[[cz,cz],[cz,cz]],colorscale:[[0,opts.color||'#3498db'],[1,opts.color||'#3498db']],opacity:opts.opacity||0.5,showscale:false}; },
    scatter3d(pts,opts={}) { return {type:'scatter3d',mode:opts.mode||'markers',x:pts.map(p=>p[0]),y:pts.map(p=>p[1]),z:pts.map(p=>p[2]),name:opts.name||'',marker:{size:opts.size||5,color:opts.color||'#58a6ff'}}; },
    line3d(pts,opts={}) { return {type:'scatter3d',mode:'lines',x:pts.map(p=>p[0]),y:pts.map(p=>p[1]),z:pts.map(p=>p[2]),name:opts.name||'',line:{width:opts.width||3,color:opts.color||'#f78166'}}; },
    arrow3d(s,e,opts={}) { return {type:'scatter3d',mode:'lines',x:[s[0],e[0]],y:[s[1],e[1]],z:[s[2],e[2]],name:opts.name||'',line:{width:opts.width||4,color:opts.color||'#f78166'}}; },
    helix(r=1,pitch=.5,turns=3,c=[0,0,0],opts={}) { const t=PlotHelpers.linspace(0,turns*2*Math.PI,opts.resolution||200); return {type:'scatter3d',mode:'lines',x:t.map(a=>c[0]+r*Math.cos(a)),y:t.map(a=>c[1]+r*Math.sin(a)),z:t.map(a=>c[2]+pitch*a/(2*Math.PI)),name:opts.name||'',line:{width:opts.width||3,color:opts.color||'#f78166'}}; },
};
function executePlotScript(source) {
    if (!source) throw new Error('No plot code');
    let code = source.replace(/`+/g,'').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&').replace(/&quot;/g,'"').replace(/&#39;/g,"'").trim();
    code = code + '\nif(typeof traces!=="undefined")return{traces:Array.isArray(traces)?traces:[traces]};\nif(typeof data!=="undefined")return{traces:Array.isArray(data)?data:[data]};';
    const keys = Object.keys(PlotHelpers), vals = Object.values(PlotHelpers);
    const fn = new Function(...keys, code);
    const res = fn(...vals);
    let traces, userLayout = {};
    if (Array.isArray(res)) { traces = res; }
    else if (res && res.traces) { traces = Array.isArray(res.traces) ? res.traces : [res.traces]; userLayout = res.layout || {}; }
    else if (res && res.type) { traces = [res]; }
    else throw new Error('Set traces = [...] with Plotly trace objects');
    const is3d = traces.some(t => t.type==='surface'||t.type==='scatter3d'||t.type==='mesh3d');
    return { traces, layout: userLayout, is3d };
}
let plotIdx = 0;
async function renderPlots() {
    const divs = Array.from(contentEl.querySelectorAll('.plot-container:not([data-processed])'));
    if (!divs.length) return;
    try { await loadPlotly(); } catch(e) { divs.forEach(d=>{ d.innerHTML='<div class="plot-error">Failed to load Plotly</div>'; d.setAttribute('data-processed','1'); }); return; }
    const styles = getComputedStyle(document.documentElement);
    const bg   = styles.getPropertyValue('--card-bg').trim()    || '#161b22';
    const text = styles.getPropertyValue('--text-color').trim() || '#e6edf3';
    const grid = styles.getPropertyValue('--border-color').trim()|| '#30363d';
    const is3dTest = /surface|sphere|cylinder|cone|box|torus|plane|scatter3d|line3d|arrow3d|helix|parametric\s*\(|parametricSurface/;
    divs.filter(d=>!is3dTest.test(d.getAttribute('data-source')||'')).forEach(d=>renderSinglePlot(d,bg,text,grid));
    divs.filter(d=> is3dTest.test(d.getAttribute('data-source')||'')).forEach((d,i)=>setTimeout(()=>renderSinglePlot(d,bg,text,grid),i*120));
}

function renderSinglePlot(div, bg, text, grid) {
    const source = div.getAttribute('data-source') || '';
    div.setAttribute('data-processed', '1');
    try {
        const { traces, layout: ul, is3d } = executePlotScript(source);
        if (!traces || !traces.length) throw new Error('No traces');
        const pid = 'plot-' + (++plotIdx) + '-' + Date.now();
        const plotH = is3d ? 420 : 360;
        div.style.height = plotH + 'px';
        div.innerHTML = `<div id="${pid}" style="width:100%;height:100%"></div>`;
        const layout = is3d ? {
            paper_bgcolor:bg, plot_bgcolor:bg, font:{color:text}, autosize:true, height:plotH,
            margin:{l:0,r:0,t:ul.title?40:10,b:0},
            scene:{aspectmode:'cube',xaxis:{gridcolor:grid,backgroundcolor:bg},yaxis:{gridcolor:grid,backgroundcolor:bg},zaxis:{gridcolor:grid,backgroundcolor:bg},bgcolor:bg,camera:{eye:{x:1.5,y:1.5,z:1.2}}},
            showlegend:traces.length>1,...ul
        } : {
            paper_bgcolor:bg, plot_bgcolor:bg, font:{color:text}, autosize:true, height:plotH,
            margin:{l:50,r:20,t:ul.title?40:20,b:40},
            xaxis:{gridcolor:grid,zerolinecolor:grid}, yaxis:{gridcolor:grid,zerolinecolor:grid},
            showlegend:traces.length>1,...ul
        };
        Plotly.newPlot(pid, traces, layout, { responsive: false, displayModeBar: true, displaylogo: false });
        requestAnimationFrame(() => { try { Plotly.Plots.resize(pid); } catch{} });
        setTimeout(() => { try { Plotly.Plots.resize(pid); } catch{} }, 250);
    } catch(e) {
        div.innerHTML = `<div class="plot-error"><strong>Plot error:</strong> ${e.message}<br><small>Example: traces = [line(x => sin(x), [-10,10])]</small></div>`;
    }
}

/* ── TOC ─────────────────────────────────────────────────────── */
let headingCounter = 0;
function updateTOC() {
    const headings = contentEl.querySelectorAll('h1,h2,h3,h4,h5,h6');
    tocList.innerHTML = '';
    if (!headings.length) { tocSidebar.classList.remove('has-headings'); return; }
    headings.forEach(h => {
        if (!h.id) { const sl = h.textContent.trim().toLowerCase().replace(/[^\w\s-]/g,'').replace(/\s+/g,'-'); h.id = `h-${sl}-${headingCounter++}`; }
        const li = document.createElement('li'), a = document.createElement('a');
        a.href = '#' + h.id; a.textContent = h.textContent; a.className = 'toc-' + h.tagName.toLowerCase();
        a.addEventListener('click', e => {
            e.preventDefault();
            const top = h.getBoundingClientRect().top - contentEl.getBoundingClientRect().top + contentEl.scrollTop;
            contentEl.scrollTo({ top, behavior: 'smooth' });
            tocList.querySelectorAll('a').forEach(l => l.classList.remove('active'));
            a.classList.add('active');
        });
        li.appendChild(a); tocList.appendChild(li);
    });
    tocSidebar.classList.add('has-headings');
    contentEl.removeEventListener('scroll', onScroll);
    contentEl.addEventListener('scroll', onScroll);
}
function onScroll() {
    const headings = contentEl.querySelectorAll('h1,h2,h3,h4,h5,h6');
    let active = null;
    const r = contentEl.getBoundingClientRect();
    headings.forEach(h => { if (h.getBoundingClientRect().top - r.top <= 80) active = h; });
    tocList.querySelectorAll('a').forEach(a => a.classList.toggle('active', active && a.getAttribute('href') === '#' + active.id));
}

/* ── Main render ─────────────────────────────────────────────── */
function renderMarkdown(src) {
    if (typeof marked === 'undefined') { contentEl.innerHTML = '<pre>' + escHtml(src) + '</pre>'; return; }
    let processed = src;
    processed = preMath(processed);
    processed = preCallouts(processed);
    processed = preContentTabs(processed);
    processed = preKeyboardKeys(processed);
    processed = preHighlights(processed);

    const tmpDiv = document.createElement('div');
    tmpDiv.innerHTML = marked.parse(processed);
    postProcess(tmpDiv);
    contentEl.innerHTML = tmpDiv.innerHTML;

    // Yield to browser so the raw HTML paints before expensive post-processing
    requestAnimationFrame(() => {
        renderMath();
        updateTOC();
        renderMermaid();
        renderPlots();
    });
}

/* ── Init ────────────────────────────────────────────────────── */
document.addEventListener('DOMContentLoaded', async function () {
    initMarked();

    try {
        const r = await fetch('/api/documents/' + DOC_UUID + '/content');
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const data = await r.json();
        rawMarkdown = data.content || '';
        renderMarkdown(rawMarkdown);
    } catch(e) {
        contentEl.innerHTML = `<p style="color:#ef4444">Failed to load document: ${e.message}</p>`;
    }

    ping();
    pollViewers();
    setInterval(ping, 15000);
    setInterval(pollViewers, 5000);
});

})();
</script>

