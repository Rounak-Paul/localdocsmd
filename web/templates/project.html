<div class="project-page">
    <nav class="breadcrumb">
        <a href="/dashboard">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            Dashboard
        </a>
        <span>/</span>
        <a href="/workspace/{{workspace_uuid}}">{{workspace_name}}</a>
        <span>/</span>
        <span>{{project_name}}</span>
    </nav>
    
    <div class="page-header">
        <div>
            <h1>{{project_name}}</h1>
            <p class="description">{{project_description}}</p>
        </div>
        <div class="actions">
            {{#if can_edit}}
            <button onclick="showCreateDocument()" class="btn btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="18" x2="12" y2="12"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
                New Document
            </button>
            <button onclick="showSettings()" class="btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                Settings
            </button>
            {{/if}}
        </div>
    </div>
    
    <div class="section">
        <h2>Documents</h2>
        <div id="documents-list" class="documents-grid">
            <div class="loading">Loading documents...</div>
        </div>
    </div>
</div>

<!-- Create Document Modal -->
<div id="create-document-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create Document</h3>
            <button onclick="closeModal('create-document-modal')" class="btn-close">&times;</button>
        </div>
        <form onsubmit="return createDocument(event)">
            <div class="form-group">
                <label for="doc-name">Document Name</label>
                <input type="text" id="doc-name" placeholder="e.g., Getting Started.md" required>
                <small>.md extension will be added automatically</small>
            </div>
            <div class="form-group">
                <label for="doc-content">Initial Content (optional)</label>
                <textarea id="doc-content" rows="4" placeholder="# Document Title&#10;&#10;Start writing here..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('create-document-modal')" class="btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Document</button>
            </div>
        </form>
    </div>
</div>

<!-- Project Settings Modal -->
<div id="settings-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Project Settings</h3>
            <button onclick="closeModal('settings-modal')" class="btn-close">&times;</button>
        </div>
        <form onsubmit="return updateProject(event)">
            <div class="form-group">
                <label for="project-edit-name">Project Name</label>
                <input type="text" id="project-edit-name" value="{{project_name}}" required>
            </div>
            <div class="form-group">
                <label for="project-edit-description">Description</label>
                <textarea id="project-edit-description" rows="3">{{project_description}}</textarea>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="deleteProject()" class="btn btn-danger">Delete Project</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
const projectUuid = '{{project_uuid}}';
const canEdit = '{{can_edit}}' === 'true';
const canManage = '{{can_manage}}' === 'true';

document.addEventListener('DOMContentLoaded', function() {
    loadDocuments();
});

async function loadDocuments() {
    try {
        const response = await fetch(`/api/projects/${projectUuid}/documents`);
        const docs = await response.json();
        
        const container = document.getElementById('documents-list');
        
        if (docs.length === 0) {
            container.innerHTML = `
                <div class="empty-state-box" style="width: 100%;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.3; margin-bottom: 1rem;">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <p class="empty-state">No documents yet</p>
                    <p style="color: var(--text-muted); font-size: 0.875rem;">Create a document to start writing</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = docs.map(doc => `
            <div class="document-item">
                <a href="/document/${doc.uuid}" class="document-link">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5; flex-shrink: 0;">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>
                    <span class="document-name">${escapeHtml(doc.name)}</span>
                </a>
                <div class="document-actions">
                    ${canEdit ? `<a href="/editor/${doc.uuid}" class="btn btn-sm">Edit</a>` : ''}
                    ${canEdit ? `<button onclick="event.stopPropagation(); renameDocument('${doc.uuid}', '${escapeHtml(doc.name).replace(/'/g, "\\'")}'  )" class="btn btn-sm">Rename</button>` : ''}
                    ${canManage ? `<button onclick="event.stopPropagation(); deleteDocument('${doc.uuid}', '${escapeHtml(doc.name).replace(/'/g, "\\'")}'  )" class="btn btn-sm btn-danger">Delete</button>` : ''}
                </div>
            </div>
        `).join('');
    } catch (err) {
        console.error('Error loading documents:', err);
        container.innerHTML = '<p class="empty-state">Error loading documents</p>';
    }
}

function showCreateDocument() {
    showModal('create-document-modal');
}

async function createDocument(e) {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating...';
    
    let name = document.getElementById('doc-name').value;
    const content = document.getElementById('doc-content').value;
    
    // Ensure .md extension
    if (!name.toLowerCase().endsWith('.md') && !name.toLowerCase().endsWith('.markdown')) {
        name += '.md';
    }
    
    try {
        const response = await fetch(`/api/projects/${projectUuid}/documents`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, content })
        });
        
        if (response.ok) {
            const doc = await response.json();
            closeModal('create-document-modal');
            window.location.href = `/editor/${doc.uuid}`;
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to create document');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Document';
        }
    } catch (err) {
        alert('Connection error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Document';
    }
    
    return false;
}

async function deleteDocument(uuid, name) {
    if (!confirm(`Delete "${name}"? This cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/documents/${uuid}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadDocuments();
        } else {
            const data = await response.json().catch(() => ({}));
            alert(data.error || 'Failed to delete document');
        }
    } catch (err) {
        alert('Connection error');
    }
}

function renameDocument(uuid, currentName) {
    document.getElementById('rename-doc-uuid').value = uuid;
    document.getElementById('rename-doc-name').value = currentName;
    showModal('rename-document-modal');
}

async function submitRenameDocument(e) {
    e.preventDefault();
    const uuid = document.getElementById('rename-doc-uuid').value;
    let name = document.getElementById('rename-doc-name').value.trim();
    if (!name) return false;

    // Ensure .md extension
    if (!name.toLowerCase().endsWith('.md') && !name.toLowerCase().endsWith('.markdown')) {
        name += '.md';
    }

    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.textContent = 'Renaming...';

    try {
        const response = await fetch(`/api/documents/${uuid}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });
        if (response.ok) {
            closeModal('rename-document-modal');
            loadDocuments();
        } else {
            const data = await response.json().catch(() => ({}));
            alert(data.error || 'Failed to rename document');
        }
    } catch (err) {
        alert('Connection error');
    }

    btn.disabled = false;
    btn.textContent = 'Rename';
    return false;
}

function showSettings() {
    showModal('settings-modal');
}

async function updateProject(e) {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';
    
    const name = document.getElementById('project-edit-name').value;
    const description = document.getElementById('project-edit-description').value;
    
    try {
        const response = await fetch(`/api/projects/${projectUuid}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description })
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to update');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Save Changes';
        }
    } catch (err) {
        alert('Connection error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Save Changes';
    }
    
    return false;
}

async function deleteProject() {
    if (!confirm('Delete this project and all its documents? This cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/projects/${projectUuid}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            window.location.href = '/workspace/{{workspace_uuid}}';
        } else {
            alert('Failed to delete project');
        }
    } catch (err) {
        alert('Connection error');
    }
}
</script>

<!-- Rename Document Modal -->
<div id="rename-document-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Rename Document</h3>
            <button onclick="closeModal('rename-document-modal')" class="btn-close">&times;</button>
        </div>
        <form onsubmit="return submitRenameDocument(event)">
            <input type="hidden" id="rename-doc-uuid">
            <div class="form-group">
                <label for="rename-doc-name">New Name</label>
                <input type="text" id="rename-doc-name" placeholder="e.g., Getting Started.md" required>
                <small>.md extension will be added if omitted</small>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('rename-document-modal')" class="btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Rename</button>
            </div>
        </form>
    </div>
</div>

<style>
.empty-state-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-2xl);
    background: var(--card-bg);
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-lg);
    text-align: center;
}
</style>
