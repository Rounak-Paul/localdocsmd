<div class="project-page">
    <nav class="breadcrumb">
        <a href="/dashboard">Dashboard</a>
        <span>/</span>
        <a href="/workspace/{{workspace_uuid}}">{{workspace_name}}</a>
        <span>/</span>
        <span>{{project_name}}</span>
    </nav>
    
    <div class="page-header">
        <div>
            <h1>{{project_name}}</h1>
            <p class="description">{{project_description}}</p>
        </div>
        <div class="actions">
            {{#if can_edit}}
            <button onclick="showCreateDocument()" class="btn btn-primary">New Document</button>
            <button onclick="showSettings()" class="btn">Settings</button>
            {{/if}}
        </div>
    </div>
    
    <div class="section">
        <h2>Documents</h2>
        <div id="documents-list" class="documents-grid">
            <div class="loading">Loading documents...</div>
        </div>
    </div>
</div>

<!-- Create Document Modal -->
<div id="create-document-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create Document</h3>
            <button onclick="closeModal('create-document-modal')" class="btn-close">&times;</button>
        </div>
        <form onsubmit="return createDocument(event)">
            <div class="form-group">
                <label for="doc-name">Name</label>
                <input type="text" id="doc-name" placeholder="e.g., Getting Started.md" required>
            </div>
            <div class="form-group">
                <label for="doc-content">Initial Content (optional)</label>
                <textarea id="doc-content" rows="4" placeholder="# Title"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('create-document-modal')" class="btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Project Settings Modal -->
<div id="settings-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Project Settings</h3>
            <button onclick="closeModal('settings-modal')" class="btn-close">&times;</button>
        </div>
        <form onsubmit="return updateProject(event)">
            <div class="form-group">
                <label for="project-edit-name">Name</label>
                <input type="text" id="project-edit-name" value="{{project_name}}" required>
            </div>
            <div class="form-group">
                <label for="project-edit-description">Description</label>
                <textarea id="project-edit-description" rows="3">{{project_description}}</textarea>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="deleteProject()" class="btn btn-danger">Delete Project</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
const projectUuid = '{{project_uuid}}';
const canEdit = {{#if can_edit}}true{{/if}}{{#unless can_edit}}false{{/unless}};

document.addEventListener('DOMContentLoaded', function() {
    loadDocuments();
});

async function loadDocuments() {
    try {
        const response = await fetch(`/api/projects/${projectUuid}/documents`);
        const docs = await response.json();
        
        const container = document.getElementById('documents-list');
        
        if (docs.length === 0) {
            container.innerHTML = '<p class="empty-state">No documents yet. Create one to start documenting.</p>';
            return;
        }
        
        container.innerHTML = docs.map(doc => `
            <div class="document-item">
                <a href="/document/${doc.uuid}" class="document-link">
                    <span class="document-icon">ðŸ“„</span>
                    <span class="document-name">${escapeHtml(doc.name)}</span>
                </a>
                ${canEdit ? `
                    <div class="document-actions">
                        <a href="/editor/${doc.uuid}" class="btn btn-sm">Edit</a>
                        <button onclick="deleteDocument('${doc.uuid}', '${escapeHtml(doc.name)}')" class="btn btn-sm btn-danger">Delete</button>
                    </div>
                ` : ''}
            </div>
        `).join('');
    } catch (err) {
        console.error('Error loading documents:', err);
    }
}

function showCreateDocument() {
    showModal('create-document-modal');
}

async function createDocument(e) {
    e.preventDefault();
    
    let name = document.getElementById('doc-name').value;
    const content = document.getElementById('doc-content').value;
    
    // Ensure .md extension
    if (!name.toLowerCase().endsWith('.md') && !name.toLowerCase().endsWith('.markdown')) {
        name += '.md';
    }
    
    try {
        const response = await fetch(`/api/projects/${projectUuid}/documents`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, content })
        });
        
        if (response.ok) {
            const doc = await response.json();
            closeModal('create-document-modal');
            window.location.href = `/editor/${doc.uuid}`;
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to create document');
        }
    } catch (err) {
        alert('Connection error');
    }
    
    return false;
}

async function deleteDocument(uuid, name) {
    if (!confirm(`Delete "${name}"? This cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/documents/${uuid}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadDocuments();
        } else {
            alert('Failed to delete document');
        }
    } catch (err) {
        alert('Connection error');
    }
}

function showSettings() {
    showModal('settings-modal');
}

async function updateProject(e) {
    e.preventDefault();
    
    const name = document.getElementById('project-edit-name').value;
    const description = document.getElementById('project-edit-description').value;
    
    try {
        const response = await fetch(`/api/projects/${projectUuid}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description })
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to update');
        }
    } catch (err) {
        alert('Connection error');
    }
    
    return false;
}

async function deleteProject() {
    if (!confirm('Delete this project and all its documents? This cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/projects/${projectUuid}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            window.location.href = '/workspace/{{workspace_uuid}}';
        } else {
            alert('Failed to delete project');
        }
    } catch (err) {
        alert('Connection error');
    }
}
</script>
