<div class="project-page">
    <nav class="breadcrumb">
        <a href="/dashboard">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            Dashboard
        </a>
        <span>/</span>
        <a href="/workspace/{{workspace_uuid}}">{{workspace_name}}</a>
        <span>/</span>
        <span>{{project_name}}</span>
    </nav>
    
    <div class="page-header">
        <div>
            <h1>{{project_name}}</h1>
            <p class="description">{{project_description}}</p>
        </div>
        <div class="actions">
            {{#if can_edit}}
            <button onclick="showCreateDocument()" class="btn btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="18" x2="12" y2="12"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
                New Document
            </button>
            <button onclick="showSettings()" class="btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                Settings
            </button>
            {{/if}}
        </div>
    </div>
    
    <div class="section">
        <h2>Documents</h2>
        <div id="tag-filter-bar" class="tag-filter-bar" style="display:none">
            <span class="tag-filter-label">Filter by tag:</span>
            <div id="tag-filter-chips" class="tag-filter-chips"></div>
            <button id="tag-filter-clear" onclick="clearTagFilter()" class="btn btn-sm" style="display:none">Clear</button>
        </div>
        <div id="documents-list" class="documents-grid">
            <div class="loading">Loading documents...</div>
        </div>
    </div>
</div>

<!-- Create Document Modal -->
<div id="create-document-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create Document</h3>
            <button onclick="closeModal('create-document-modal')" class="btn-close">&times;</button>
        </div>
        <form onsubmit="return createDocument(event)">
            <div class="form-group">
                <label for="doc-name">Document Name</label>
                <input type="text" id="doc-name" placeholder="e.g., Getting Started.md" required>
                <small>.md extension will be added automatically</small>
            </div>
            <div class="form-group">
                <label for="doc-content">Initial Content (optional)</label>
                <textarea id="doc-content" rows="4" placeholder="# Document Title&#10;&#10;Start writing here..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('create-document-modal')" class="btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Document</button>
            </div>
        </form>
    </div>
</div>

<!-- Project Settings Modal -->
<div id="settings-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Project Settings</h3>
            <button onclick="closeModal('settings-modal')" class="btn-close">&times;</button>
        </div>
        <form onsubmit="return updateProject(event)">
            <div class="form-group">
                <label for="project-edit-name">Project Name</label>
                <input type="text" id="project-edit-name" value="{{project_name}}" required>
            </div>
            <div class="form-group">
                <label for="project-edit-description">Description</label>
                <textarea id="project-edit-description" rows="3">{{project_description}}</textarea>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="deleteProject()" class="btn btn-danger">Delete Project</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
const projectUuid = '{{project_uuid}}';
const canEdit = '{{can_edit}}' === 'true';
const canManage = '{{can_manage}}' === 'true';

let _allDocs = [];
let _activeTagFilter = null;  // tag id (number) or null

document.addEventListener('DOMContentLoaded', function() {
    loadDocuments();
});

async function loadDocuments() {
    try {
        const response = await fetch(`/api/projects/${projectUuid}/documents`);
        _allDocs = await response.json();
        buildTagFilterBar();
        renderDocs();
    } catch (err) {
        console.error('Error loading documents:', err);
        document.getElementById('documents-list').innerHTML = '<p class="empty-state">Error loading documents</p>';
    }
}

function buildTagFilterBar() {
    // Collect unique tags from all docs
    const tagMap = new Map();
    _allDocs.forEach(doc => (doc.tags || []).forEach(t => tagMap.set(t.id, t)));
    const bar = document.getElementById('tag-filter-bar');
    if (tagMap.size === 0) { bar.style.display = 'none'; return; }
    bar.style.display = 'flex';
    const chips = document.getElementById('tag-filter-chips');
    chips.innerHTML = Array.from(tagMap.values()).map(t =>
        `<button class="tag-pill tag-${t.color} tag-filter-chip${_activeTagFilter===t.id?' active':''}" data-tag-id="${t.id}" onclick="toggleTagFilter(${t.id})">${escapeHtml(t.name)}</button>`
    ).join('');
    document.getElementById('tag-filter-clear').style.display = _activeTagFilter ? '' : 'none';
}

function toggleTagFilter(tagId) {
    _activeTagFilter = _activeTagFilter === tagId ? null : tagId;
    buildTagFilterBar();
    renderDocs();
}

function clearTagFilter() {
    _activeTagFilter = null;
    buildTagFilterBar();
    renderDocs();
}

function renderDocs() {
    const container = document.getElementById('documents-list');
    const docs = _activeTagFilter
        ? _allDocs.filter(d => (d.tags||[]).some(t => t.id === _activeTagFilter))
        : _allDocs;

    if (docs.length === 0) {
        if (_activeTagFilter) {
            container.innerHTML = `<div class="empty-state-box" style="width:100%"><p class="empty-state">No documents with this tag</p></div>`;
        } else {
            container.innerHTML = `
                <div class="empty-state-box" style="width: 100%;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.3; margin-bottom: 1rem;">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <p class="empty-state">No documents yet</p>
                    <p style="color: var(--text-muted); font-size: 0.875rem;">Create a document to start writing</p>
                </div>
            `;
        }
        return;
    }

    container.innerHTML = docs.map(doc => {
            const tagsHtml = doc.tags && doc.tags.length
                ? `<div class="doc-tags">${doc.tags.map(t =>
                    `<span class="tag-pill tag-${t.color}" data-tag-id="${t.id}">${escapeHtml(t.name)}</span>`
                ).join('')}</div>`
                : '';
            const createdBy = doc.created_by_username
                ? `<span class="doc-created-by">by ${escapeHtml(doc.created_by_username)}</span>`
                : '';
            return `
            <div class="document-item" data-doc-uuid="${doc.uuid}" data-tag-ids="${(doc.tags||[]).map(t=>t.id).join(',')}">
                <a href="/document/${doc.uuid}" class="document-link">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5; flex-shrink: 0;">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>
                    <div class="doc-info">
                        <span class="document-name">${escapeHtml(doc.name)}</span>
                        <span class="doc-meta-inline">${formatSize(doc.size)} &middot; Updated ${relativeTime(doc.updated_at)}${createdBy ? ' &middot; ' + createdBy : ''}</span>
                        ${tagsHtml}
                    </div>
                </a>
                <div class="document-actions">
                    ${canEdit ? `<a href="/editor/${doc.uuid}" class="btn btn-sm">Edit</a>` : ''}
                    ${canEdit ? `<button onclick="event.stopPropagation(); openTagsModal('${doc.uuid}', '${escapeHtml(doc.name).replace(/'/g, "\\'")}')" class="btn btn-sm" title="Manage tags">&#127991;</button>` : ''}
                    ${canEdit ? `<button onclick="event.stopPropagation(); renameDocument('${doc.uuid}', '${escapeHtml(doc.name).replace(/'/g, "\\'")}'  )" class="btn btn-sm">Rename</button>` : ''}
                    ${canManage ? `<button onclick="event.stopPropagation(); deleteDocument('${doc.uuid}', '${escapeHtml(doc.name).replace(/'/g, "\\'")}'  )" class="btn btn-sm btn-danger">Delete</button>` : ''}
                </div>
            </div>`;
        }).join('');
}

function showCreateDocument() {
    showModal('create-document-modal');
}

function relativeTime(unixSec) {
    if (!unixSec) return 'never';
    const diff = Math.floor(Date.now() / 1000) - unixSec;
    if (diff < 60) return 'just now';
    if (diff < 3600) { const m = Math.floor(diff/60); return m + ' minute' + (m>1?'s':'') + ' ago'; }
    if (diff < 86400) { const h = Math.floor(diff/3600); return h + ' hour' + (h>1?'s':'') + ' ago'; }
    if (diff < 2592000) { const d = Math.floor(diff/86400); return d + ' day' + (d>1?'s':'') + ' ago'; }
    if (diff < 31536000) { const mo = Math.floor(diff/2592000); return mo + ' month' + (mo>1?'s':'') + ' ago'; }
    const y = Math.floor(diff/31536000); return y + ' year' + (y>1?'s':'') + ' ago';
}

function formatSize(bytes) {
    if (!bytes || bytes === 0) return '0 B';
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
}

async function createDocument(e) {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating...';
    
    let name = document.getElementById('doc-name').value;
    const content = document.getElementById('doc-content').value;
    
    // Ensure .md extension
    if (!name.toLowerCase().endsWith('.md') && !name.toLowerCase().endsWith('.markdown')) {
        name += '.md';
    }
    
    try {
        const response = await fetch(`/api/projects/${projectUuid}/documents`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, content })
        });
        
        if (response.ok) {
            const doc = await response.json();
            closeModal('create-document-modal');
            window.location.href = `/editor/${doc.uuid}`;
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to create document');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Document';
        }
    } catch (err) {
        alert('Connection error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Document';
    }
    
    return false;
}

async function deleteDocument(uuid, name) {
    if (!confirm(`Delete "${name}"? This cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/documents/${uuid}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadDocuments();
        } else {
            const data = await response.json().catch(() => ({}));
            alert(data.error || 'Failed to delete document');
        }
    } catch (err) {
        alert('Connection error');
    }
}

function renameDocument(uuid, currentName) {
    document.getElementById('rename-doc-uuid').value = uuid;
    document.getElementById('rename-doc-name').value = currentName;
    showModal('rename-document-modal');
}

async function submitRenameDocument(e) {
    e.preventDefault();
    const uuid = document.getElementById('rename-doc-uuid').value;
    let name = document.getElementById('rename-doc-name').value.trim();
    if (!name) return false;

    // Ensure .md extension
    if (!name.toLowerCase().endsWith('.md') && !name.toLowerCase().endsWith('.markdown')) {
        name += '.md';
    }

    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.textContent = 'Renaming...';

    try {
        const response = await fetch(`/api/documents/${uuid}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });
        if (response.ok) {
            closeModal('rename-document-modal');
            loadDocuments();
        } else {
            const data = await response.json().catch(() => ({}));
            alert(data.error || 'Failed to rename document');
        }
    } catch (err) {
        alert('Connection error');
    }

    btn.disabled = false;
    btn.textContent = 'Rename';
    return false;
}

function showSettings() {
    showModal('settings-modal');
}

async function updateProject(e) {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';
    
    const name = document.getElementById('project-edit-name').value;
    const description = document.getElementById('project-edit-description').value;
    
    try {
        const response = await fetch(`/api/projects/${projectUuid}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description })
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to update');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Save Changes';
        }
    } catch (err) {
        alert('Connection error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Save Changes';
    }
    
    return false;
}

async function deleteProject() {
    if (!confirm('Delete this project and all its documents? This cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/projects/${projectUuid}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            window.location.href = '/workspace/{{workspace_uuid}}';
        } else {
            alert('Failed to delete project');
        }
    } catch (err) {
        alert('Connection error');
    }
}

/* ───────── Tag management ───────── */
let _tagsModalDocUuid = null;

async function openTagsModal(docUuid, docName) {
    _tagsModalDocUuid = docUuid;
    document.getElementById('tags-modal-doc-name').textContent = docName;
    document.getElementById('tags-modal-doc-uuid').value = docUuid;
    document.getElementById('tags-modal-new-name').value = '';
    await loadTagsModal();
    await loadTagSuggestions();
    showModal('tags-modal');
}

async function loadTagsModal() {
    const res = await fetch(`/api/documents/${_tagsModalDocUuid}/tags`);
    const tags = await res.json();
    const container = document.getElementById('tags-modal-current');
    if (!tags.length) {
        container.innerHTML = '<span style="color:var(--text-muted);font-size:0.8rem">No tags yet</span>';
        return;
    }
    container.innerHTML = tags.map(t =>
        `<span class="tag-pill tag-${t.color} removable" onclick="removeTagFromModal(${t.id})">${escapeHtml(t.name)}</span>`
    ).join('');
}

async function loadTagSuggestions() {
    const res = await fetch('/api/tags');
    const tags = await res.json();
    const box = document.getElementById('tags-modal-suggestions');
    if (!tags.length) { box.style.display='none'; return; }
    box.style.display = 'flex';
    box.innerHTML = '<span style="font-size:0.75rem;color:var(--text-muted);margin-right:0.3rem">All tags:</span>' +
        tags.map(t =>
            `<span class="tag-pill tag-suggestion tag-${t.color}" onclick="setTagInput('${escapeHtml(t.name).replace(/'/g,"\\'")}','${t.color}')">${escapeHtml(t.name)}</span>`
        ).join('');
}

function setTagInput(name, color) {
    document.getElementById('tags-modal-new-name').value = name;
    document.getElementById('tags-modal-new-color').value = color;
}

async function addTagFromModal() {
    const name = document.getElementById('tags-modal-new-name').value.trim();
    const color = document.getElementById('tags-modal-new-color').value;
    if (!name) return;
    await fetch(`/api/documents/${_tagsModalDocUuid}/tags`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({name, color})
    });
    document.getElementById('tags-modal-new-name').value = '';
    await loadTagsModal();
    await loadTagSuggestions();
}

async function removeTagFromModal(tagId) {
    await fetch(`/api/documents/${_tagsModalDocUuid}/tags/${tagId}`, {method:'DELETE'});
    await loadTagsModal();
}
</script>

<!-- Rename Document Modal -->
<div id="rename-document-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Rename Document</h3>
            <button onclick="closeModal('rename-document-modal')" class="btn-close">&times;</button>
        </div>
        <form onsubmit="return submitRenameDocument(event)">
            <input type="hidden" id="rename-doc-uuid">
            <div class="form-group">
                <label for="rename-doc-name">New Name</label>
                <input type="text" id="rename-doc-name" placeholder="e.g., Getting Started.md" required>
                <small>.md extension will be added if omitted</small>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('rename-document-modal')" class="btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Rename</button>
            </div>
        </form>
    </div>
</div>

<!-- Tag Management Modal -->
<div id="tags-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width:480px">
        <div class="modal-header">
            <h3>Tags – <span id="tags-modal-doc-name"></span></h3>
            <button onclick="closeModal('tags-modal')" class="btn-close">&times;</button>
        </div>
        <input type="hidden" id="tags-modal-doc-uuid">
        <div class="form-group" style="margin-top:1rem">
            <label>Current tags</label>
            <div id="tags-modal-current" class="doc-tags" style="min-height:2rem;gap:0.4rem;flex-wrap:wrap"></div>
        </div>
        <div class="form-group">
            <label>Add tag</label>
            <div style="display:flex;gap:0.5rem;align-items:center">
                <input type="text" id="tags-modal-new-name" placeholder="Tag name" style="flex:1" onkeydown="if(event.key==='Enter'){event.preventDefault();addTagFromModal();}">
                <select id="tags-modal-new-color" style="width:100px">
                    <option value="blue">Blue</option>
                    <option value="green">Green</option>
                    <option value="red">Red</option>
                    <option value="purple">Purple</option>
                    <option value="orange">Orange</option>
                    <option value="gray">Gray</option>
                </select>
                <button onclick="addTagFromModal()" class="btn btn-sm btn-primary">Add</button>
            </div>
            <div id="tags-modal-suggestions" class="tags-suggestions" style="display:none;margin-top:0.5rem"></div>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal('tags-modal');loadDocuments();" class="btn">Done</button>
        </div>
    </div>
</div>

<style>
.empty-state-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-2xl);
    background: var(--card-bg);
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-lg);
    text-align: center;
}

.document-link {
    align-items: flex-start !important;
}

.doc-info {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    min-width: 0;
}

.doc-meta-inline {
    font-size: 0.75rem;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.doc-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
    margin-top: 0.15rem;
}

.doc-created-by {
    color: var(--text-muted);
}

.tag-pill {
    display: inline-flex;
    align-items: center;
    font-size: 0.7rem;
    font-weight: 500;
    padding: 0.15rem 0.5rem;
    border-radius: 999px;
    white-space: nowrap;
    cursor: default;
    user-select: none;
}
.tag-pill.tag-blue   { background:rgba(88,166,255,.18); color:#58a6ff; border:1px solid rgba(88,166,255,.3); }
.tag-pill.tag-green  { background:rgba(63,185,80,.18);  color:#3fb950; border:1px solid rgba(63,185,80,.3); }
.tag-pill.tag-red    { background:rgba(248,81,73,.18);  color:#f85149; border:1px solid rgba(248,81,73,.3); }
.tag-pill.tag-purple { background:rgba(188,140,255,.18);color:#bc8cff; border:1px solid rgba(188,140,255,.3); }
.tag-pill.tag-orange { background:rgba(255,165,0,.18);  color:#ffa500; border:1px solid rgba(255,165,0,.3); }
.tag-pill.tag-gray   { background:rgba(139,148,158,.18);color:#8b949e; border:1px solid rgba(139,148,158,.3); }

.tag-pill.removable { cursor:pointer; }
.tag-pill.removable::after { content:'×'; margin-left:0.3rem; opacity:0.6; }

.tag-filter-bar {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
    padding: 0.5rem 0;
    margin-bottom: 0.75rem;
    border-bottom: 1px solid var(--border-color);
}
.tag-filter-label { font-size: 0.8rem; color: var(--text-muted); flex-shrink: 0; }
.tag-filter-chips { display: flex; flex-wrap: wrap; gap: 0.3rem; }
.tag-filter-chip { cursor: pointer; opacity: 0.7; transition: opacity 0.15s; }
.tag-filter-chip:hover, .tag-filter-chip.active { opacity: 1; }
.tag-filter-chip.active { outline: 2px solid currentColor; outline-offset: 1px; }

.tags-suggestions { display: flex; flex-wrap: wrap; gap: 0.3rem; }
.tag-suggestion { cursor: pointer; }
.tag-suggestion:hover { opacity: 0.8; }
</style>
