<div class="workspace-page">
    <nav class="breadcrumb">
        <a href="/dashboard">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            Dashboard
        </a>
        <span>/</span>
        <span>{{workspace_name}}</span>
    </nav>
    
    <div class="page-header">
        <div>
            <h1>{{workspace_name}}</h1>
            <p class="description">{{workspace_description}}</p>
        </div>
        <div class="actions">
            {{#if can_edit}}
            <button onclick="showCreateProject()" class="btn btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 5v14"></path>
                    <path d="M5 12h14"></path>
                </svg>
                New Project
            </button>
            {{/if}}
            {{#if is_admin}}
            <button onclick="showMembers()" class="btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                Members
            </button>
            <button onclick="showSettings()" class="btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                Settings
            </button>
            {{/if}}
        </div>
    </div>
    
    <div class="section">
        <h2>Projects</h2>
        <div id="projects-list" class="grid">
            <div class="loading">Loading projects...</div>
        </div>
    </div>
</div>

<!-- Create Project Modal -->
<div id="create-project-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create Project</h3>
            <button onclick="closeModal('create-project-modal')" class="btn-close">&times;</button>
        </div>
        <form onsubmit="return createProject(event)">
            <div class="form-group">
                <label for="project-name">Project Name</label>
                <input type="text" id="project-name" placeholder="e.g., API Documentation" required>
            </div>
            <div class="form-group">
                <label for="project-description">Description</label>
                <textarea id="project-description" rows="3" placeholder="Brief description of this project..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('create-project-modal')" class="btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Project</button>
            </div>
        </form>
    </div>
</div>

<!-- Members Modal -->
<div id="members-modal" class="modal" style="display: none;">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3>Workspace Members</h3>
            <button onclick="closeModal('members-modal')" class="btn-close">&times;</button>
        </div>
        <div class="modal-body">
            <div id="members-list" class="members-list-container"></div>
            <div class="add-member-section">
                <h4>Add Member</h4>
                <form onsubmit="return addMember(event)" class="form-inline">
                    <div class="user-search-container">
                        <input type="text" id="member-search" placeholder="Search by name or email..." autocomplete="off"
                               oninput="searchUsers(this.value)" onfocus="searchUsers(this.value)">
                        <input type="hidden" id="member-uuid">
                        <div id="user-search-results" class="search-dropdown" style="display: none;"></div>
                    </div>
                    <select id="member-role">
                        <option value="viewer">Viewer</option>
                        <option value="editor">Editor</option>
                        <option value="manager">Manager</option>
                    </select>
                    <button type="submit" class="btn btn-primary">Add</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Workspace Settings</h3>
            <button onclick="closeModal('settings-modal')" class="btn-close">&times;</button>
        </div>
        <form onsubmit="return updateWorkspace(event)">
            <div class="form-group">
                <label for="ws-edit-name">Workspace Name</label>
                <input type="text" id="ws-edit-name" value="{{workspace_name}}" required>
            </div>
            <div class="form-group">
                <label for="ws-edit-description">Description</label>
                <textarea id="ws-edit-description" rows="3">{{workspace_description}}</textarea>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="deleteWorkspace()" class="btn btn-danger">Delete Workspace</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<style>
.user-search-container {
    position: relative;
    flex: 1;
}

.add-member-section {
    margin-top: var(--spacing-xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--divider);
}

.add-member-section h4 {
    margin-bottom: var(--spacing-md);
    font-size: 0.9375rem;
    font-weight: 600;
}

.members-list-container .table {
    margin: 0;
}
</style>

<script>
const workspaceUuid = '{{workspace_uuid}}';

document.addEventListener('DOMContentLoaded', function() {
    loadProjects();
});

async function loadProjects() {
    try {
        const response = await fetch(`/api/workspaces/${workspaceUuid}/projects`);
        const projects = await response.json();
        
        const container = document.getElementById('projects-list');
        
        if (projects.length === 0) {
            container.innerHTML = `
                <div class="empty-state-box">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.3; margin-bottom: 1rem;">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <p class="empty-state">No projects yet</p>
                    <p style="color: var(--text-muted); font-size: 0.875rem;">Create a project to organize your documentation</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = projects.map(p => `
            <div class="card" onclick="window.location='/project/${p.uuid}'">
                <div class="card-header">
                    <h3>${escapeHtml(p.name)}</h3>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.4;">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                </div>
                <div class="card-body">
                    <p>${escapeHtml(p.description || 'No description')}</p>
                </div>
            </div>
        `).join('');
    } catch (err) {
        console.error('Error loading projects:', err);
        document.getElementById('projects-list').innerHTML = '<p class="empty-state">Error loading projects</p>';
    }
}

function showCreateProject() {
    showModal('create-project-modal');
}

async function createProject(e) {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating...';
    
    const name = document.getElementById('project-name').value;
    const description = document.getElementById('project-description').value;
    
    try {
        const response = await fetch(`/api/workspaces/${workspaceUuid}/projects`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description })
        });
        
        if (response.ok) {
            closeModal('create-project-modal');
            loadProjects();
            e.target.reset();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to create project');
        }
    } catch (err) {
        alert('Connection error');
    }
    
    submitBtn.disabled = false;
    submitBtn.textContent = 'Create Project';
    
    return false;
}

async function showMembers() {
    showModal('members-modal');
    
    try {
        const response = await fetch(`/api/workspaces/${workspaceUuid}/members`);
        const members = await response.json();
        
        const container = document.getElementById('members-list');
        
        if (members.length === 0) {
            container.innerHTML = '<p>No members</p>';
            return;
        }
        
        container.innerHTML = `
            <table class="table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${members.map(m => `
                        <tr>
                            <td>${escapeHtml(m.username)}</td>
                            <td><span class="badge badge-${m.role}">${m.role}</span></td>
                            <td>
                                <button onclick="removeMember('${m.user_uuid}')" class="btn btn-sm btn-danger">Remove</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } catch (err) {
        alert('Failed to load members');
    }
}

async function addMember(e) {
    e.preventDefault();
    
    const userUuid = document.getElementById('member-uuid').value;
    if (!userUuid) {
        alert('Please select a user from the search results');
        return false;
    }
    const role = document.getElementById('member-role').value;
    
    try {
        const response = await fetch(`/api/workspaces/${workspaceUuid}/members`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_uuid: userUuid, role })
        });
        
        if (response.ok) {
            document.getElementById('member-search').value = '';
            document.getElementById('member-uuid').value = '';
            showMembers();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to add member');
        }
    } catch (err) {
        alert('Connection error');
    }
    
    return false;
}

let searchTimeout = null;
async function searchUsers(query) {
    clearTimeout(searchTimeout);
    const resultsDiv = document.getElementById('user-search-results');
    
    if (!query || query.length < 1) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    // Debounce the search
    searchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
            const users = await response.json();
            
            if (users.length === 0) {
                resultsDiv.innerHTML = '<div class="search-dropdown-item">No users found</div>';
            } else {
                resultsDiv.innerHTML = users.map(u => `
                    <div class="search-dropdown-item" onclick="selectUser('${u.uuid}', '${u.username}')">
                        <div class="username">${u.username}</div>
                        <div class="email">${u.email}</div>
                    </div>
                `).join('');
            }
            resultsDiv.style.display = 'block';
        } catch (err) {
            console.error('Search error:', err);
        }
    }, 200);
}

function selectUser(uuid, username) {
    document.getElementById('member-uuid').value = uuid;
    document.getElementById('member-search').value = username;
    document.getElementById('user-search-results').style.display = 'none';
}

// Hide dropdown when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.user-search-container')) {
        const resultsDiv = document.getElementById('user-search-results');
        if (resultsDiv) resultsDiv.style.display = 'none';
    }
});

async function removeMember(userUuid) {
    if (!confirm('Remove this member?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/workspaces/${workspaceUuid}/members/${userUuid}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showMembers();
        } else {
            alert('Failed to remove member');
        }
    } catch (err) {
        alert('Connection error');
    }
}

function showSettings() {
    showModal('settings-modal');
}

async function updateWorkspace(e) {
    e.preventDefault();
    
    const name = document.getElementById('ws-edit-name').value;
    const description = document.getElementById('ws-edit-description').value;
    
    try {
        const response = await fetch(`/api/workspaces/${workspaceUuid}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description })
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to update');
        }
    } catch (err) {
        alert('Connection error');
    }
    
    return false;
}

async function deleteWorkspace() {
    if (!confirm('Delete this workspace? This will delete all projects and documents. This cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/workspaces/${workspaceUuid}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            window.location.href = '/dashboard';
        } else {
            alert('Failed to delete workspace');
        }
    } catch (err) {
        alert('Connection error');
    }
}
</script>
