<!-- Editor CDN dependencies -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked-highlight/lib/index.umd.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/morphdom@2.7.2/dist/morphdom-umd.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

<div class="editor-page">
    <nav class="breadcrumb">
        <a href="/dashboard">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            Dashboard
        </a>
        <span>/</span>
        <a href="/project/{{project_uuid}}">{{project_name}}</a>
        <span>/</span>
        <span>{{document_name}}</span>
    </nav>

    <div class="editor-header">
        <h1>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
            {{document_name}}
        </h1>
        <div class="editor-actions">
            <span id="save-status" class="save-status"></span>
            <button onclick="toggleHelp()" class="btn" id="help-btn" title="Markdown reference (Ctrl+/)">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.92 6.085h.001a.749.749 0 1 1-1.342-.67c.169-.339.436-.701.849-.977C6.845 4.16 7.369 4 8 4a2.756 2.756 0 0 1 1.637.525c.503.377.863.965.863 1.725 0 .448-.115.83-.329 1.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6.24 6.24 0 0 0-.26.16.952.952 0 0 0-.276.245.75.75 0 0 1-1.248-.832c.184-.264.42-.489.692-.661.103-.067.207-.132.313-.195l.007-.004c.1-.061.182-.11.258-.161a.969.969 0 0 0 .277-.245C8.96 6.514 9 6.427 9 6.25a.612.612 0 0 0-.262-.525A1.27 1.27 0 0 0 8 5.5c-.369 0-.595.09-.74.187a1.01 1.01 0 0 0-.34.398ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>
                Help
            </button>
            <button onclick="saveDocument()" class="btn btn-primary" id="save-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                Save
            </button>
            <a href="/document/{{document_uuid}}" class="btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                View
            </a>
        </div>
    </div>

    <div class="editor-container">
        <!-- Left pane: Markdown editor -->
        <div class="editor-pane">
            <div class="pane-header">
                <span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.6"><path d="M14.85 3c.63 0 1.15.52 1.14 1.15v7.7c0 .63-.51 1.15-1.15 1.15H1.15C.52 13 0 12.48 0 11.84V4.15C0 3.52.52 3 1.15 3zM9 11V5H7L5.5 7 4 5H2v6h2V8l1.5 1.92L7 8v3zm2.99.5L14.5 8H13V5h-2v3H9.5z" fill="currentColor" stroke="none"/></svg>
                    Markdown
                </span>
            </div>
            <textarea id="editor" class="editor-textarea" placeholder="# Start writing...&#10;&#10;Use **bold**, *italic*, or ==highlight==.&#10;Add math with $E = mc^2$ or $$\sum_{n=1}^{\infty} \frac{1}{n^2} = \frac{\pi^2}{6}$$&#10;Use > [!note] for callouts."></textarea>
            <div class="editor-status-bar">
                <span id="status-pos">Ln 1, Col 1</span>
                <span id="status-chars">0 chars</span>
                <span id="status-words">0 words</span>
            </div>
        </div>

        <!-- Right pane: Preview with TOC -->
        <div class="preview-pane">
            <div class="pane-header">
                <span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.6"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    Preview
                </span>
                <div class="viewer-presence" id="viewer-presence" title="Active viewers"></div>
            </div>
            <div class="preview-content-wrapper" id="preview-wrapper">
                <nav class="toc-sidebar" id="toc-sidebar">
                    <div class="toc-header">Contents</div>
                    <ul class="toc-list" id="toc-list"></ul>
                </nav>
                <div id="preview" class="markdown-body preview-scroll"></div>
            </div>
        </div>
    </div>
</div>

<!-- Help Panel -->
<div class="help-overlay" id="help-overlay" onclick="toggleHelp()"></div>
<div class="help-panel" id="help-panel">
    <div class="help-panel-header">
        <span>
            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.92 6.085h.001a.749.749 0 1 1-1.342-.67c.169-.339.436-.701.849-.977C6.845 4.16 7.369 4 8 4a2.756 2.756 0 0 1 1.637.525c.503.377.863.965.863 1.725 0 .448-.115.83-.329 1.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6.24 6.24 0 0 0-.26.16.952.952 0 0 0-.276.245.75.75 0 0 1-1.248-.832c.184-.264.42-.489.692-.661.103-.067.207-.132.313-.195l.007-.004c.1-.061.182-.11.258-.161a.969.969 0 0 0 .277-.245C8.96 6.514 9 6.427 9 6.25a.612.612 0 0 0-.262-.525A1.27 1.27 0 0 0 8 5.5c-.369 0-.595.09-.74.187a1.01 1.01 0 0 0-.34.398ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>
            Markdown Reference
        </span>
        <button class="help-close-btn" onclick="toggleHelp()" title="Close (Esc)">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"/></svg>
        </button>
    </div>
    <div class="help-panel-body">
        <div class="help-section">
            <h3>Headings</h3>
            <div class="help-row"><code># Heading 1</code><span>H1</span></div>
            <div class="help-row"><code>## Heading 2</code><span>H2</span></div>
            <div class="help-row"><code>### Heading 3</code><span>H3</span></div>
        </div>
        <div class="help-section">
            <h3>Emphasis</h3>
            <div class="help-row"><code>**bold**</code><span><strong>bold</strong></span></div>
            <div class="help-row"><code>*italic*</code><span><em>italic</em></span></div>
            <div class="help-row"><code>~~strike~~</code><span><s>strike</s></span></div>
            <div class="help-row"><code>==highlight==</code><span><mark>highlight</mark></span></div>
        </div>
        <div class="help-section">
            <h3>Code</h3>
            <div class="help-row"><code>`inline code`</code><span>inline</span></div>
            <div class="help-row"><code>```js↵code↵```</code><span>fenced block</span></div>
        </div>
        <div class="help-section">
            <h3>Lists</h3>
            <div class="help-row"><code>- item</code><span>unordered</span></div>
            <div class="help-row"><code>1. item</code><span>ordered</span></div>
            <div class="help-row"><code>- [ ] task</code><span>checkbox</span></div>
        </div>
        <div class="help-section">
            <h3>Links &amp; Images</h3>
            <div class="help-row"><code>[text](url)</code><span>link</span></div>
            <div class="help-row"><code>![alt](url)</code><span>image</span></div>
        </div>
        <div class="help-section">
            <h3>Blocks</h3>
            <div class="help-row"><code>&gt; quote</code><span>blockquote</span></div>
            <div class="help-row"><code>---</code><span>divider</span></div>
            <div class="help-row"><code>| A | B |↵|---|---|↵| 1 | 2 |</code><span>table</span></div>
        </div>
        <div class="help-section">
            <h3>Math (KaTeX)</h3>
            <div class="help-row"><code>$E = mc^2$</code><span>inline</span></div>
            <div class="help-row"><code>$$↵\sum x↵$$</code><span>block</span></div>
        </div>
        <div class="help-section">
            <h3>Callouts</h3>
            <div class="help-row"><code>&gt; [!note] Title</code><span class="chip note">note</span></div>
            <div class="help-row"><code>&gt; [!tip]</code><span class="chip tip">tip</span></div>
            <div class="help-row"><code>&gt; [!warning]</code><span class="chip warning">warning</span></div>
            <div class="help-row"><code>&gt; [!danger]</code><span class="chip danger">danger</span></div>
            <div class="help-row muted">Also: info, important, success, question, failure, bug, error</div>
            <div class="help-row muted">Add content as <code>&gt; text</code> on next lines</div>
        </div>
        <div class="help-section">
            <h3>Keyboard Shortcuts</h3>
            <div class="help-row"><kbd>Ctrl</kbd>+<kbd>S</kbd><span>Save</span></div>
            <div class="help-row"><kbd>Ctrl</kbd>+<kbd>B</kbd><span>Bold</span></div>
            <div class="help-row"><kbd>Ctrl</kbd>+<kbd>I</kbd><span>Italic</span></div>
            <div class="help-row"><kbd>Ctrl</kbd>+<kbd>/</kbd><span>Toggle help</span></div>
            <div class="help-row"><kbd>Tab</kbd><span>Indent (4 spaces)</span></div>
            <div class="help-row"><kbd>Shift</kbd>+<kbd>Tab</kbd><span>Outdent</span></div>
        </div>
    </div>
</div>
<!-- Floating help tab (always visible on right edge) -->
<div class="help-tab" id="help-tab" onclick="toggleHelp()" title="Markdown reference (Ctrl+/)">
    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.92 6.085h.001a.749.749 0 1 1-1.342-.67c.169-.339.436-.701.849-.977C6.845 4.16 7.369 4 8 4a2.756 2.756 0 0 1 1.637.525c.503.377.863.965.863 1.725 0 .448-.115.83-.329 1.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6.24 6.24 0 0 0-.26.16.952.952 0 0 0-.276.245.75.75 0 0 1-1.248-.832c.184-.264.42-.489.692-.661.103-.067.207-.132.313-.195l.007-.004c.1-.061.182-.11.258-.161a.969.969 0 0 0 .277-.245C8.96 6.514 9 6.427 9 6.25a.612.612 0 0 0-.262-.525A1.27 1.27 0 0 0 8 5.5c-.369 0-.595.09-.74.187a1.01 1.01 0 0 0-.34.398ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>
</div>

<style>
/* ── Reset main container for editor ── */
main.container {
    max-width: 100% !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
    overflow: visible !important;
}

/* ── Editor page: fixed below navbar, fills rest of viewport ── */
.editor-page {
    position: fixed;
    top: 64px;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    padding: var(--spacing-xs) var(--spacing-lg) 0;
    background: var(--bg-gradient);
    background-attachment: fixed;
    overflow: hidden;
    z-index: 1;
}

/* Tighten breadcrumb inside editor */
.editor-page .breadcrumb {
    margin-bottom: 2px;
    padding: 2px 0;
    flex-shrink: 0;
}

.editor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0 6px;
    flex-shrink: 0;
}

.editor-header h1 {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: 1.1rem;
    font-weight: 600;
}

.editor-actions {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.save-status {
    font-size: 0.8125rem;
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-sm);
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
}
.save-status.status-saved   { color: var(--success-color); }
.save-status.status-unsaved { color: var(--warning-color); background: rgba(245,158,11,.1); }
.save-status.status-saving  { color: var(--text-muted); }
.save-status.status-error   { color: var(--danger-color); background: rgba(239,68,68,.1); }

/* ── Split panes ──────────────────────────────────── */
.editor-container {
    flex: 1;
    display: flex;
    gap: var(--spacing-md);
    min-height: 0;
    overflow: hidden;
    padding-bottom: var(--spacing-sm);
}

.editor-pane,
.preview-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--card-shadow);
    min-width: 0;
}

.editor-pane:focus-within {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--input-focus-ring);
}

.pane-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 16px;
    background: var(--divider);
    border-bottom: 1px solid var(--border-color);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    flex-shrink: 0;
}

.pane-header span {
    display: flex;
    align-items: center;
    gap: 6px;
}

/* ── Help panel ──────────────────────────────────── */
.help-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 9998;
    backdrop-filter: blur(2px);
}
.help-overlay.open { display: block; }

.help-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: 360px;
    max-width: 100vw;
    height: 100vh;
    background: var(--card-bg);
    border-left: 1px solid var(--card-border);
    box-shadow: -4px 0 32px rgba(0,0,0,0.4);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.22s cubic-bezier(0.4,0,0.2,1);
}
.help-panel.open { transform: translateX(0); }

/* Floating help trigger tab on right edge */
.help-tab {
    position: fixed;
    right: 0;
    top: 50%;
    transform: translateY(-50%) translateX(0);
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-right: none;
    border-radius: var(--radius-sm) 0 0 var(--radius-sm);
    padding: 10px 8px;
    cursor: pointer;
    z-index: 9997;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: -2px 0 10px rgba(0,0,0,0.15);
    transition: color 0.15s, background 0.15s, transform 0.22s cubic-bezier(0.4,0,0.2,1);
}
.help-tab:hover { color: var(--text-color); background: var(--hover-bg); }
.help-tab.panel-open { transform: translateY(-50%) translateX(-360px); }

.help-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 18px;
    background: var(--divider);
    border-bottom: 1px solid var(--border-color);
    font-size: 0.8rem;
    font-weight: 600;
    flex-shrink: 0;
}
.help-panel-header > span {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-color);
}
.help-close-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--text-muted);
    cursor: pointer;
}
.help-close-btn:hover { background: var(--hover-bg); color: var(--text-color); }

.help-panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.help-section { margin-bottom: 16px; }
.help-section h3 {
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-muted);
    margin: 0 0 8px;
    padding-bottom: 5px;
    border-bottom: 1px solid var(--border-color);
}
.help-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    padding: 4px 0;
    font-size: 0.79rem;
}
.help-row code {
    font-family: var(--font-mono);
    font-size: 0.74rem;
    background: var(--divider);
    padding: 2px 6px;
    border-radius: 4px;
    color: var(--text-color);
    white-space: pre;
    border: 1px solid var(--border-color);
}
.help-row > span { color: var(--text-secondary); font-size: 0.78rem; text-align: right; flex-shrink: 0; }
.help-row kbd {
    display: inline-flex;
    align-items: center;
    padding: 2px 6px;
    background: var(--divider);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: var(--text-color);
}
.help-row.muted { color: var(--text-muted); font-size: 0.74rem; justify-content: flex-start; gap: 6px; }
.help-row .chip {
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.72rem;
    font-weight: 600;
}
.help-row .chip.note     { color: #3b82f6; background: rgba(59,130,246,.12); }
.help-row .chip.tip      { color: #10b981; background: rgba(16,185,129,.12); }
.help-row .chip.warning  { color: #f59e0b; background: rgba(245,158,11,.12); }
.help-row .chip.danger   { color: #ef4444; background: rgba(239,68,68,.12); }

/* ── Editor textarea ──────────────────────────────── */
.editor-textarea {
    flex: 1;
    width: 100%;
    padding: 24px 28px;
    background: var(--card-bg);
    color: var(--text-color);
    border: none;
    outline: none;
    resize: none;
    overflow-y: auto;
    font-family: var(--font-mono);
    font-size: 13.5px;
    line-height: 1.65;
    tab-size: 4;
}

.editor-status-bar {
    display: flex;
    gap: 16px;
    padding: 4px 16px;
    background: var(--divider);
    border-top: 1px solid var(--border-color);
    font-size: 0.7rem;
    color: var(--text-muted);
    flex-shrink: 0;
}

/* ── Preview content wrapper with TOC ───────────────── */
.preview-content-wrapper {
    display: flex;
    flex: 1;
    overflow: hidden;
    min-height: 0;
}

.toc-sidebar {
    width: 210px;
    min-width: 210px;
    background: var(--divider);
    border-right: 1px solid var(--border-color);
    overflow-y: auto;
    padding: 14px 0;
    flex-shrink: 0;
    display: none;
}
.toc-sidebar.has-headings { display: block; }

.toc-header {
    padding: 0 14px 10px;
    font-size: 0.68rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 6px;
}

.toc-list { list-style: none; margin: 0; padding: 0; }
.toc-list li { margin: 0; }
.toc-list a {
    display: block;
    padding: 5px 14px;
    font-size: 0.78rem;
    color: var(--text-muted);
    text-decoration: none;
    border-left: 2px solid transparent;
    transition: all 0.12s ease;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.toc-list a:hover  { color: var(--text-color); background: var(--hover-bg); }
.toc-list a.active { color: var(--primary-color); border-left-color: var(--primary-color); background: var(--hover-bg); }

.toc-list .toc-h1 { padding-left: 14px; font-weight: 600; }
.toc-list .toc-h2 { padding-left: 14px; font-weight: 500; }
.toc-list .toc-h3 { padding-left: 26px; }
.toc-list .toc-h4 { padding-left: 38px; font-size: 0.72rem; }
.toc-list .toc-h5 { padding-left: 50px; font-size: 0.72rem; }
.toc-list .toc-h6 { padding-left: 62px; font-size: 0.72rem; }

.preview-scroll {
    flex: 1;
    overflow-y: auto;
    padding: 24px 32px;
    min-width: 0;
}

/* ── Viewer presence ──────────────────────────────── */
.viewer-presence {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-wrap: wrap;
}

.viewer-chip {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--primary-color);
    color: #fff;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    title: attr(data-username);
    cursor: default;
    border: 2px solid var(--card-bg);
    box-sizing: content-box;
}

.viewer-chip:nth-child(2) { background: #10b981; }
.viewer-chip:nth-child(3) { background: #f59e0b; }
.viewer-chip:nth-child(4) { background: #ef4444; }
.viewer-chip:nth-child(5) { background: #8b5cf6; }
.viewer-chip-more {
    font-size: 0.65rem;
    color: var(--text-muted);
    padding: 0 4px;
    white-space: nowrap;
}

/* ── Markdown body overrides ──────────────────────── */
.preview-scroll.markdown-body {
    background: transparent !important;
    color: var(--text-color) !important;
    font-family: var(--font-sans) !important;
    font-size: 15px;
    line-height: 1.7;
}

.markdown-body h1, .markdown-body h2, .markdown-body h3,
.markdown-body h4, .markdown-body h5, .markdown-body h6 {
    color: var(--text-color) !important;
    border-bottom-color: var(--border-color) !important;
}
.markdown-body blockquote {
    border-left-color: var(--border-color) !important;
    color: var(--text-secondary) !important;
}
.markdown-body table tr { background: var(--card-bg) !important; border-top-color: var(--border-color) !important; }
.markdown-body table tr:nth-child(2n) { background: var(--divider) !important; }
.markdown-body table th, .markdown-body table td { border-color: var(--border-color) !important; }
.markdown-body hr { background: var(--border-color) !important; }
.markdown-body a { color: var(--primary-color) !important; }
.markdown-body img { max-width: 100%; border-radius: 6px; border: 1px solid var(--border-color); }

/* Code blocks */
.markdown-body pre {
    position: relative;
    background: var(--input-bg, #1e1e1e) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 8px !important;
    padding: 0 !important;
    overflow: hidden;
    margin: 16px 0;
}

.code-copy-btn {
    position: absolute;
    top: 8px; right: 8px;
    padding: 3px 8px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    color: var(--text-muted);
    font-size: 11px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.15s ease;
    z-index: 1;
}
.markdown-body pre:hover .code-copy-btn { opacity: 1; }
.code-copy-btn:hover { background: var(--border-color); color: var(--text-color); }
.code-copy-btn.copied { color: var(--success-color); }

.markdown-body pre code {
    display: block;
    padding: 14px 16px !important;
    overflow-x: auto;
    background: transparent !important;
    font-size: 13px;
    line-height: 1.55;
}

.markdown-body code {
    background: var(--divider) !important;
    color: var(--text-color) !important;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.9em;
}

/* Line numbers */
.code-line { display: block; }
.line-number {
    display: inline-block;
    width: 3em;
    padding-right: 1em;
    text-align: right;
    color: var(--text-muted);
    user-select: none;
    opacity: 0.45;
    font-size: 12px;
}
.line-content { display: inline; }

/* Callouts */
.callout {
    padding: 12px 16px;
    margin: 16px 0;
    border-radius: 8px;
    border-left: 4px solid;
    background: var(--divider);
}
.callout-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 0.9rem;
}
.callout-title svg { width: 16px; height: 16px; flex-shrink: 0; }
.callout-content p:last-child { margin-bottom: 0; }

.callout-note    { border-left-color: #3b82f6; }
.callout-note .callout-title    { color: #3b82f6; }
.callout-tip     { border-left-color: #10b981; }
.callout-tip .callout-title     { color: #10b981; }
.callout-warning { border-left-color: #f59e0b; }
.callout-warning .callout-title { color: #f59e0b; }
.callout-danger, .callout-error { border-left-color: #ef4444; }
.callout-danger .callout-title,
.callout-error .callout-title   { color: #ef4444; }
.callout-info    { border-left-color: #3b82f6; }
.callout-info .callout-title    { color: #3b82f6; }
.callout-important  { border-left-color: #8b5cf6; }
.callout-important .callout-title { color: #8b5cf6; }
.callout-success { border-left-color: #10b981; }
.callout-success .callout-title { color: #10b981; }
.callout-question { border-left-color: #f59e0b; }
.callout-question .callout-title { color: #f59e0b; }
.callout-bug, .callout-failure { border-left-color: #ef4444; }
.callout-bug .callout-title,
.callout-failure .callout-title { color: #ef4444; }

/* Highlight/mark */
mark {
    background: rgba(245,158,11,.3);
    color: var(--text-color);
    padding: 1px 3px;
    border-radius: 2px;
}

/* Math */
.math-block  { margin: 20px 0; padding: 16px; text-align: center; overflow-x: auto; }
.math-inline { display: inline; }
.math-error  { color: #ef4444; font-family: var(--font-mono); font-size: 12px; }
.katex-display { margin: 0 !important; }

/* Task lists */
.markdown-body .task-list-item { list-style-type: none; }
.markdown-body .task-list-item input[type="checkbox"] { margin-right: 8px; accent-color: var(--primary-color); }

@media (max-width: 768px) {
    .editor-container { flex-direction: column; }
    .toc-sidebar { display: none !important; }
    .editor-page { padding: var(--spacing-sm); }
}
</style>

<script>
(function() {
'use strict';

const DOC_UUID = '{{document_uuid}}';
const CURRENT_USER = '{{username}}';

// ── DOM refs ───────────────────────────────────────────────────────────────
const editorEl   = document.getElementById('editor');
const previewEl  = document.getElementById('preview');
const tocSidebar = document.getElementById('toc-sidebar');
const tocList    = document.getElementById('toc-list');
const saveBtn    = document.getElementById('save-btn');
const saveStatus = document.getElementById('save-status');
const statusPos  = document.getElementById('status-pos');
const statusChars= document.getElementById('status-chars');
const statusWords= document.getElementById('status-words');
const viewerEl   = document.getElementById('viewer-presence');
const previewWrapper = document.getElementById('preview-wrapper');

// ── State ──────────────────────────────────────────────────────────────────
let content        = '';
let lastSaved      = '';
let renderTimer    = null;
let saveTimer      = null;
let viewers        = [];

// ── Decode content from template ──────────────────────────────────────────
function decodeContent(encoded) {
    try { return JSON.parse('"' + encoded + '"'); } catch(e) { return encoded; }
}

// ── Markdown parsing helpers ───────────────────────────────────────────────
function parseCallouts(src) {
    const calloutIcons = {
        note:'<svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>',
        tip: '<svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"/></svg>',
        warning:'<svg viewBox="0 0 16 16" fill="currentColor"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>',
        danger:'<svg viewBox="0 0 16 16" fill="currentColor"><path d="M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>',
        info:'<svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>',
        important:'<svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>',
        success:'<svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"/></svg>',
        question:'<svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.92 6.085h.001a.749.749 0 1 1-1.342-.67c.169-.339.436-.701.849-.977C6.845 4.16 7.369 4 8 4a2.756 2.756 0 0 1 1.637.525c.503.377.863.965.863 1.725 0 .448-.115.83-.329 1.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6.24 6.24 0 0 0-.26.16.952.952 0 0 0-.276.245.75.75 0 0 1-1.248-.832c.184-.264.42-.489.692-.661.103-.067.207-.132.313-.195l.007-.004c.1-.061.182-.11.258-.161a.969.969 0 0 0 .277-.245C8.96 6.514 9 6.427 9 6.25a.612.612 0 0 0-.262-.525A1.27 1.27 0 0 0 8 5.5c-.369 0-.595.09-.74.187a1.01 1.01 0 0 0-.34.398ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>',
        failure:'<svg viewBox="0 0 16 16" fill="currentColor"><path d="M2.343 13.657A8 8 0 1 1 13.658 2.343 8 8 0 0 1 2.343 13.657ZM6.03 4.97a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042L6.94 8 4.97 9.97a.749.749 0 0 0 .326 1.275.749.749 0 0 0 .734-.215L8 9.06l1.97 1.97a.749.749 0 0 0 1.275-.326.749.749 0 0 0-.215-.734L9.06 8l1.97-1.97a.749.749 0 0 0-.326-1.275.749.749 0 0 0-.734.215L8 6.94Z"/></svg>',
        bug:'<svg viewBox="0 0 16 16" fill="currentColor"><path d="M4.72.22a.749.749 0 0 1 1.06 0l.97.97.97-.97a.749.749 0 1 1 1.06 1.06l-.97.97.97.97a.749.749 0 0 1-1.06 1.06L6.75 3.28l-.97.97a.749.749 0 0 1-1.06-1.06l.97-.97-.97-.97a.749.749 0 0 1 0-1.06ZM3.5 8.5a.5.5 0 0 0-1 0v.25H1a.75.75 0 0 0 0 1.5h1.5v1H1a.75.75 0 0 0 0 1.5h1.62c.26 1.31 1.2 2.37 2.45 2.88L3.95 16h8.1l-1.12-.37c1.25-.51 2.19-1.57 2.45-2.88H15a.75.75 0 0 0 0-1.5h-1.5v-1H15a.75.75 0 0 0 0-1.5h-1.5V8.5a.5.5 0 0 0-1 0v.25H3.5V8.5Z"/></svg>',
        error:'<svg viewBox="0 0 16 16" fill="currentColor"><path d="M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>',
    };
    return src.replace(/^>\s*\[!(note|tip|warning|danger|error|info|important|success|question|failure|bug)\]([^\n]*)\n((?:>[^\n]*\n?)*)/gim,
        (_, type, title, body) => {
            const t = type.toLowerCase();
            const icon = calloutIcons[t] || calloutIcons.note;
            const label = title.trim() || (t.charAt(0).toUpperCase() + t.slice(1));
            const clean = body.split('\n').map(l => l.replace(/^>\s?/, '')).join('\n').trim();
            return `<div class="callout callout-${t}"><div class="callout-title">${icon}${label}</div><div class="callout-content">\n\n${clean}\n\n</div></div>\n`;
        });
}

function parseHighlights(src) {
    const blocks = [];
    src = src.replace(/```[\s\S]*?```|`[^`]+`/g, m => { blocks.push(m); return `\x00CB${blocks.length-1}\x00`; });
    src = src.replace(/==([^=\n]+)==/g, '<mark>$1</mark>');
    return src.replace(/\x00CB(\d+)\x00/g, (_, i) => blocks[+i]);
}

function parseMath(src) {
    const blocks = [];
    src = src.replace(/```[\s\S]*?```|`[^`]+`/g, m => { blocks.push(m); return `\x00CB${blocks.length-1}\x00`; });
    src = src.replace(/\$\$([\s\S]+?)\$\$/g, (_, m) =>
        `<div class="math-block" data-math="${encodeURIComponent(m.trim())}"></div>`);
    src = src.replace(/(?<!\$)\$(?!\$)([^$\n]+?)(?<!\$)\$(?!\$)/g, (_, m) =>
        `<span class="math-inline" data-math="${encodeURIComponent(m.trim())}"></span>`);
    return src.replace(/\x00CB(\d+)\x00/g, (_, i) => blocks[+i]);
}

// ── Marked.js initialization ───────────────────────────────────────────────
function initMarked() {
    if (typeof marked === 'undefined') return;
    const hlFn = (typeof markedHighlight !== 'undefined')
        ? (markedHighlight.markedHighlight || markedHighlight)
        : null;

    if (hlFn && typeof hljs !== 'undefined') {
        marked.use(hlFn({
            langPrefix: 'hljs language-',
            highlight(code, lang) {
                if (!lang) return code;
                const lines = code.split('\n');
                return lines.map((line, i) =>
                    `<span class="code-line"><span class="line-number">${i+1}</span><span class="line-content">${
                        hljs.getLanguage(lang)
                            ? hljs.highlight(line, {language: lang, ignoreIllegals: true}).value
                            : line
                    }</span></span>`
                ).join('\n');
            }
        }));
    }
    marked.setOptions({ breaks: true, gfm: true });
}

// ── Render markdown to preview ─────────────────────────────────────────────
function render() {
    if (typeof marked === 'undefined') return;
    let src = editorEl.value;
    src = parseMath(src);
    src = parseCallouts(src);
    src = parseHighlights(src);

    const newDiv = document.createElement('div');
    newDiv.innerHTML = marked.parse(src);

    // Add copy buttons to code blocks
    newDiv.querySelectorAll('pre').forEach(pre => {
        const btn = document.createElement('button');
        btn.className = 'code-copy-btn';
        btn.textContent = 'Copy';
        btn.addEventListener('click', function() {
            const code = pre.querySelector('code');
            if (!code) return;
            const text = Array.from(code.querySelectorAll('.line-content')).map(el => el.textContent).join('\n')
                         || code.textContent;
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
            });
        });
        pre.appendChild(btn);
    });

    // Patch DOM efficiently
    if (typeof morphdom !== 'undefined') {
        morphdom(previewEl, newDiv, {
            childrenOnly: true,
            onBeforeElUpdated(from, to) {
                return !from.isEqualNode(to);
            }
        });
    } else {
        previewEl.innerHTML = newDiv.innerHTML;
    }

    renderMath();
    updateTOC();
}

// ── Math rendering ─────────────────────────────────────────────────────────
function renderMath() {
    if (typeof katex === 'undefined') return;
    previewEl.querySelectorAll('.math-block:not([data-rendered])').forEach(el => {
        try {
            katex.render(decodeURIComponent(el.dataset.math), el, {displayMode:true, throwOnError:false});
            el.dataset.rendered = '1';
        } catch(e) { el.innerHTML = `<span class="math-error">${e.message}</span>`; }
    });
    previewEl.querySelectorAll('.math-inline:not([data-rendered])').forEach(el => {
        try {
            katex.render(decodeURIComponent(el.dataset.math), el, {displayMode:false, throwOnError:false});
            el.dataset.rendered = '1';
        } catch(e) { el.innerHTML = `<span class="math-error">${e.message}</span>`; }
    });
}

// ── Table of Contents ──────────────────────────────────────────────────────
let headingCounter = 0;
function updateTOC() {
    const headings = previewEl.querySelectorAll('h1,h2,h3,h4,h5,h6');
    tocList.innerHTML = '';
    if (headings.length === 0) {
        tocSidebar.classList.remove('has-headings');
        return;
    }
    headingCounter = 0;
    headings.forEach(h => {
        if (!h.id) {
            const slug = h.textContent.trim().toLowerCase().replace(/[^\w\s-]/g,'').replace(/\s+/g,'-');
            h.id = `h-${slug}-${headingCounter++}`;
        }
        const li = document.createElement('li');
        const a  = document.createElement('a');
        a.href = '#' + h.id;
        a.textContent = h.textContent;
        a.className = 'toc-' + h.tagName.toLowerCase();
        a.addEventListener('click', e => {
            e.preventDefault();
            h.scrollIntoView({behavior:'smooth', block:'start'});
            tocList.querySelectorAll('a').forEach(l => l.classList.remove('active'));
            a.classList.add('active');
        });
        li.appendChild(a);
        tocList.appendChild(li);
    });
    tocSidebar.classList.add('has-headings');
    setupTOCScrollSpy();
}

function setupTOCScrollSpy() {
    previewEl.removeEventListener('scroll', onPreviewScroll);
    previewEl.addEventListener('scroll', onPreviewScroll);
}
function onPreviewScroll() {
    const headings = previewEl.querySelectorAll('h1,h2,h3,h4,h5,h6');
    let active = null;
    headings.forEach(h => {
        const rect = h.getBoundingClientRect();
        const preRect = previewEl.getBoundingClientRect();
        if (rect.top - preRect.top <= 80) active = h;
    });
    tocList.querySelectorAll('a').forEach(a => {
        a.classList.toggle('active', active && a.getAttribute('href') === '#' + active.id);
    });
}

// ── Status bar ─────────────────────────────────────────────────────────────
function updateStatusBar() {
    const val = editorEl.value;
    const pos = editorEl.selectionStart;
    const before = val.substring(0, pos).split('\n');
    statusPos.textContent   = `Ln ${before.length}, Col ${before[before.length-1].length+1}`;
    statusChars.textContent = `${val.length} chars`;
    statusWords.textContent = `${val.trim() ? val.trim().split(/\s+/).length : 0} words`;
}

// ── Debounce helper ────────────────────────────────────────────────────────
function debounce(fn, ms) {
    let t;
    return function(...args) { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
}
const debouncedRender = debounce(render, 60);

// ── Save ───────────────────────────────────────────────────────────────────
function setSaveStatus(state, text) {
    saveStatus.textContent = text;
    saveStatus.className   = 'save-status status-' + state;
    if (state === 'unsaved') saveBtn.disabled = false;
}

window.saveDocument = async function() {
    if (content === lastSaved) return;
    saveBtn.disabled = true;
    setSaveStatus('saving', 'Saving…');
    try {
        const r = await fetch(`/api/documents/${DOC_UUID}/content`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({content})
        });
        if (r.ok) {
            lastSaved = content;
            setSaveStatus('saved', 'Saved');
        } else {
            const d = await r.json().catch(()=>({}));
            setSaveStatus('error', 'Save failed');
            saveBtn.disabled = false;
            console.error('Save error:', d);
        }
    } catch(err) {
        setSaveStatus('error', 'Connection error');
        saveBtn.disabled = false;
    }
};

// ── Help panel ─────────────────────────────────────────────────────────────
window.toggleHelp = function() {
    const panel   = document.getElementById('help-panel');
    const overlay = document.getElementById('help-overlay');
    const tab     = document.getElementById('help-tab');
    const isOpen  = panel.classList.contains('open');
    panel.classList.toggle('open',   !isOpen);
    overlay.classList.toggle('open', !isOpen);
    if (tab) tab.classList.toggle('panel-open', !isOpen);
};

// ── Toolbar insertion helpers ──────────────────────────────────────────────
window.insertMarkdown = function(before, after='') {
    const s = editorEl.selectionStart;
    const e = editorEl.selectionEnd;
    const sel = editorEl.value.substring(s, e);
    editorEl.value = editorEl.value.substring(0,s) + before + sel + after + editorEl.value.substring(e);
    editorEl.selectionStart = sel ? s + before.length : s + before.length;
    editorEl.selectionEnd   = sel ? s + before.length + sel.length : s + before.length;
    editorEl.focus();
    content = editorEl.value;
    setSaveStatus('unsaved', 'Unsaved changes');
    debouncedRender();
    updateStatusBar();
};

window.insertTable = function() {
    insertMarkdown('\n| Header 1 | Header 2 | Header 3 |\n|----------|----------|----------|\n| Cell 1   | Cell 2   | Cell 3   |\n');
};
window.insertMath = function() {
    insertMarkdown('$$\n', '\n$$');
};
window.insertCallout = function() {
    insertMarkdown('> [!note] ');
};

// ── Viewer presence ────────────────────────────────────────────────────────
async function pingServer() {
    try {
        await fetch(`/api/documents/${DOC_UUID}/ping`, {method:'POST'});
    } catch(_) {}
}

async function pollViewers() {
    try {
        const r = await fetch(`/api/documents/${DOC_UUID}/viewers`);
        if (!r.ok) return;
        const data = await r.json();
        viewers = (data.viewers || []).filter(v => v.username !== CURRENT_USER);
        renderViewers();
    } catch(_) {}
}

function renderViewers() {
    if (viewers.length === 0) { viewerEl.innerHTML = ''; return; }
    const max = 4;
    let html = '';
    const shown = viewers.slice(0, max);
    const extra = viewers.length - max;
    shown.forEach(v => {
        const letter = v.username.charAt(0).toUpperCase();
        html += `<span class="viewer-chip" title="${v.username}">${letter}</span>`;
    });
    if (extra > 0) html += `<span class="viewer-chip-more">+${extra}</span>`;
    viewerEl.innerHTML = html;
}

// ── Init ───────────────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', function() {
    // Move help panel/overlay/tab to <body> to escape any stacking context issues
    const helpPanel   = document.getElementById('help-panel');
    const helpOverlay = document.getElementById('help-overlay');
    const helpTab     = document.getElementById('help-tab');
    if (helpPanel)   document.body.appendChild(helpPanel);
    if (helpOverlay) document.body.appendChild(helpOverlay);
    if (helpTab)     document.body.appendChild(helpTab);

    content     = decodeContent('{{content}}');
    lastSaved   = content;
    editorEl.value = content;

    initMarked();
    render();
    updateStatusBar();

    // Ping immediately then every 15 seconds
    pingServer();
    setInterval(pingServer, 15000);

    // Poll viewers every 5 seconds
    pollViewers();
    setInterval(pollViewers, 5000);

    // Editor input handler
    editorEl.addEventListener('input', function() {
        content = editorEl.value;
        setSaveStatus('unsaved', 'Unsaved changes');
        debouncedRender();
        updateStatusBar();
    });

    // Cursor move → status bar
    const onCursor = () => requestAnimationFrame(updateStatusBar);
    editorEl.addEventListener('keyup',   onCursor);
    editorEl.addEventListener('click',   onCursor);
    editorEl.addEventListener('select',  onCursor);

    // Keyboard shortcuts
    editorEl.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            if (e.key === 's') { e.preventDefault(); window.saveDocument(); return; }
            if (e.key === 'b') { e.preventDefault(); insertMarkdown('**','**'); return; }
            if (e.key === 'i') { e.preventDefault(); insertMarkdown('*','*'); return; }
            if (e.key === '/') { e.preventDefault(); window.toggleHelp(); return; }
        }
        // Tab / shift-tab indent
        if (e.key === 'Tab') {
            e.preventDefault();
            const s = this.selectionStart, en = this.selectionEnd;
            if (e.shiftKey) {
                const before = this.value.substring(0, s);
                const ls = before.lastIndexOf('\n') + 1;
                const lc = this.value.substring(ls, s);
                if (lc.startsWith('    ') || lc.startsWith('\t')) {
                    const n = lc.startsWith('    ') ? 4 : 1;
                    this.value = this.value.substring(0,ls) + this.value.substring(ls+n);
                    this.selectionStart = this.selectionEnd = s - n;
                }
            } else {
                this.value = this.value.substring(0,s) + '    ' + this.value.substring(en);
                this.selectionStart = this.selectionEnd = s + 4;
            }
            content = this.value;
            setSaveStatus('unsaved', 'Unsaved changes');
            debouncedRender();
            updateStatusBar();
        }
    });

    // Close help panel on Escape
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            const panel = document.getElementById('help-panel');
            if (panel.classList.contains('open')) window.toggleHelp();
        }
    });

    // Warn on leave with unsaved
    window.addEventListener('beforeunload', e => {
        if (content !== lastSaved) { e.preventDefault(); e.returnValue = ''; }
    });

    setSaveStatus('saved', 'Saved');
    editorEl.focus();
});

})();
</script>
