<div class="admin-page">
    <div class="page-header">
        <div>
            <h1>Admin Panel</h1>
            <p class="description">Manage users, workspaces, and system settings</p>
        </div>
    </div>
    
    <script>const currentUsername = '{{username}}';</script>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="stat-users">-</div>
            <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-workspaces">-</div>
            <div class="stat-label">Workspaces</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-pending">-</div>
            <div class="stat-label">Pending Password Changes</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-forgot">-</div>
            <div class="stat-label">Forgot Password Requests</div>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab active" onclick="showTab('users')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Users
        </button>
        <button class="tab" onclick="showTab('password-requests')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            Password Requests
        </button>
        <button class="tab" onclick="showTab('forgot-requests')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            Forgot Password
        </button>
    </div>
    
    <!-- Users Tab -->
    <div id="users-tab" class="tab-content">
        <div class="section-header">
            <h2>User Management</h2>
            <button onclick="showCreateUser()" class="btn btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <line x1="19" y1="8" x2="19" y2="14"></line>
                    <line x1="22" y1="11" x2="16" y2="11"></line>
                </svg>
                Add User
            </button>
        </div>
        <div class="table-container">
            <table class="table" id="users-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-tbody">
                    <tr><td colspan="5" class="loading">Loading users...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Password Requests Tab -->
    <div id="password-requests-tab" class="tab-content" style="display: none;">
        <div class="section-header">
            <h2>Pending Password Changes</h2>
        </div>
        <div class="table-container">
            <table class="table" id="requests-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Requested</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="requests-tbody">
                    <tr><td colspan="3" class="loading">Loading requests...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Forgot Password Requests Tab -->
    <div id="forgot-requests-tab" class="tab-content" style="display: none;">
        <div class="section-header">
            <h2>Forgot Password Requests</h2>
            <p style="margin:0; color: var(--text-secondary); font-size:0.9em;">Users who cannot log in and asked for a password reset.</p>
        </div>
        <div class="table-container">
            <table class="table" id="forgot-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Requested</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="forgot-tbody">
                    <tr><td colspan="3" class="loading">Loading requests...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Generated Password Modal -->
<div id="generated-password-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>User Created — Save This Password</h3>
            <button onclick="closeModal('generated-password-modal')" class="btn-close">&times;</button>
        </div>
        <p style="color: var(--text-secondary); font-size:0.9em; margin-bottom: var(--spacing-md);">
            No password was specified, so one was generated automatically for
            <strong id="gen-pass-username"></strong>.
            Share it with the user — <strong>it will not be shown again.</strong>
            They will be required to change it on first login.
        </p>
        <div style="display:flex; align-items:center; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
            <code id="gen-pass-value" style="
                flex: 1;
                background: var(--bg-secondary, #1a1f2e);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-md);
                padding: var(--spacing-sm) var(--spacing-md);
                font-family: monospace;
                font-size: 1.1em;
                letter-spacing: 0.05em;
                color: var(--primary-color);
            "></code>
            <button onclick="copyGeneratedPassword()" class="btn" id="copy-gen-pass-btn">Copy</button>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal('generated-password-modal')" class="btn btn-primary">Done</button>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div id="create-user-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New User</h3>
            <button onclick="closeModal('create-user-modal')" class="btn-close">&times;</button>
        </div>
        <form onsubmit="return createUser(event)">
            <div class="form-group">
                <label for="user-username">Username</label>
                <input type="text" id="user-username" placeholder="Enter username" required>
            </div>
            <div class="form-group">
                <label for="user-email">Email</label>
                <input type="email" id="user-email" placeholder="Enter email address" required>
            </div>
            <div class="form-group">
                <label for="user-password">Initial Password</label>
                <input type="password" id="user-password" placeholder="Leave blank for random" minlength="8">
                <small>Leave blank to generate a random password</small>
            </div>
            <div class="form-group">
                <label for="user-role">Role</label>
                <select id="user-role">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('create-user-modal')" class="btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Create User</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit User Modal -->
<div id="edit-user-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit User</h3>
            <button onclick="closeModal('edit-user-modal')" class="btn-close">&times;</button>
        </div>
        <form onsubmit="return updateUser(event)">
            <input type="hidden" id="edit-user-uuid">
            <div class="form-group">
                <label for="edit-user-email">Email</label>
                <input type="email" id="edit-user-email" required>
            </div>
            <div class="form-group">
                <label for="edit-user-role">Role</label>
                <select id="edit-user-role">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-user-status">Status</label>
                <select id="edit-user-status">
                    <option value="0">Pending</option>
                    <option value="1">Active</option>
                    <option value="2">Locked</option>
                    <option value="3">Disabled</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('edit-user-modal')" class="btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Set Temporary Password Modal (used for both admin reset and forgot-request handling) -->
<div id="set-password-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="set-password-title">Set Temporary Password</h3>
            <button onclick="closeModal('set-password-modal')" class="btn-close">&times;</button>
        </div>
        <p id="set-password-desc" style="color: var(--text-secondary); font-size:0.9em; margin-bottom: var(--spacing-md);">
            The user will be required to change this password on next login.
        </p>
        <form onsubmit="return submitSetPassword(event)">
            <input type="hidden" id="set-password-target-type">  <!-- 'user' or 'forgot' -->
            <input type="hidden" id="set-password-target-id">
            <div class="form-group">
                <label for="set-password-value">New Temporary Password</label>
                <input type="password" id="set-password-value" placeholder="Enter temporary password" required minlength="8">
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('set-password-modal')" class="btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Set Password</button>
            </div>
        </form>
    </div>
</div>

<style>
.btn-warning {
    background-color: var(--warning-color, #f59e0b);
    color: #fff;
    border-color: var(--warning-color, #f59e0b);
}
.btn-warning:hover {
    opacity: 0.85;
}

.admin-page .tab {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.admin-page .tab svg {
    opacity: 0.6;
}

.admin-page .tab.active svg {
    opacity: 1;
}

.table-container {
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--card-shadow);
}

.admin-page .table td {
    vertical-align: middle;
}

.admin-page .section-header h2 {
    margin: 0;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadUsers();
    loadPasswordRequests();
    loadForgotRequests();
});

async function loadStats() {
    try {
        const response = await fetch('/api/admin/stats');
        const stats = await response.json();
        
        animateValue('stat-users', 0, stats.users, 500);
        animateValue('stat-workspaces', 0, stats.workspaces, 500);
        animateValue('stat-pending', 0, stats.pending_password_requests, 500);
        animateValue('stat-forgot', 0, stats.pending_forgot_requests || 0, 500);
    } catch (err) {
        console.error('Error loading stats:', err);
    }
}

function animateValue(id, start, end, duration) {
    const element = document.getElementById(id);
    const range = end - start;
    const startTime = performance.now();
    
    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const value = Math.floor(start + range * easeOutQuart(progress));
        element.textContent = value;
        
        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }
    
    requestAnimationFrame(update);
}

function easeOutQuart(x) {
    return 1 - Math.pow(1 - x, 4);
}

function showTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    
    document.querySelector(`[onclick="showTab('${tab}')"]`).classList.add('active');
    document.getElementById(`${tab}-tab`).style.display = 'block';
}

async function loadUsers() {
    try {
        const response = await fetch('/api/users');
        const users = await response.json();
        
        const tbody = document.getElementById('users-tbody');
        
        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No users found</td></tr>';
            return;
        }
        
        const statusLabels = ['Pending', 'Active', 'Locked', 'Disabled', 'Password Reset'];
        
        tbody.innerHTML = users.map(user => `
            <tr>
                <td><strong>${escapeHtml(user.username)}</strong></td>
                <td>${escapeHtml(user.email)}</td>
                <td><span class="badge badge-${user.role}">${user.role}</span></td>
                <td><span class="badge badge-status-${user.status}">${statusLabels[user.status] || 'Unknown'}</span></td>
                <td>
                    <div style="display: flex; gap: var(--spacing-xs);">
                        <button onclick="editUser('${user.uuid}')" class="btn btn-sm">Edit</button>
                        <button onclick="resetUserPassword('${user.uuid}', '${escapeHtml(user.username)}')" class="btn btn-sm btn-warning">Reset Password</button>
                        ${user.username !== currentUsername ? `<button onclick="deleteUser('${user.uuid}', '${escapeHtml(user.username)}')" class="btn btn-sm btn-danger">Delete</button>` : ''}
                    </div>
                </td>
            </tr>
        `).join('');
    } catch (err) {
        console.error('Error loading users:', err);
    }
}

async function loadPasswordRequests() {
    try {
        const response = await fetch('/api/admin/password-requests');
        const requests = await response.json();
        
        const tbody = document.getElementById('requests-tbody');
        
        if (requests.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No pending requests</td></tr>';
            return;
        }
        
        tbody.innerHTML = requests.map(req => `
            <tr>
                <td><strong>${escapeHtml(req.username)}</strong></td>
                <td>${new Date(req.created_at * 1000).toLocaleString()}</td>
                <td>
                    <div style="display: flex; gap: var(--spacing-xs);">
                        <button onclick="approvePassword(${req.id})" class="btn btn-sm btn-success">Approve</button>
                        <button onclick="rejectPassword(${req.id})" class="btn btn-sm btn-danger">Reject</button>
                    </div>
                </td>
            </tr>
        `).join('');
    } catch (err) {
        console.error('Error loading password requests:', err);
    }
}

function showCreateUser() {
    showModal('create-user-modal');
}

async function createUser(e) {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating...';
    
    const data = {
        username: document.getElementById('user-username').value,
        email: document.getElementById('user-email').value,
        password: document.getElementById('user-password').value || undefined,
        role: document.getElementById('user-role').value
    };
    
    try {
        const response = await fetch('/api/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const data = await response.json();
            closeModal('create-user-modal');
            loadUsers();
            loadStats();
            e.target.reset();
            if (data.generated_password) {
                showGeneratedPassword(data.username, data.generated_password);
            }
        } else {
            const err = await response.json();
            alert(err.error || 'Failed to create user');
        }
    } catch (err) {
        alert('Connection error');
    }
    
    submitBtn.disabled = false;
    submitBtn.textContent = 'Create User';
    
    return false;
}

async function editUser(uuid) {
    try {
        const response = await fetch(`/api/users/${uuid}`);
        const user = await response.json();
        
        document.getElementById('edit-user-uuid').value = uuid;
        document.getElementById('edit-user-email').value = user.email;
        document.getElementById('edit-user-role').value = user.role;
        document.getElementById('edit-user-status').value = user.status;
        
        showModal('edit-user-modal');
    } catch (err) {
        alert('Failed to load user');
    }
}

async function updateUser(e) {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';
    
    const uuid = document.getElementById('edit-user-uuid').value;
    const data = {
        email: document.getElementById('edit-user-email').value,
        role: document.getElementById('edit-user-role').value,
        status: parseInt(document.getElementById('edit-user-status').value)
    };
    
    try {
        const response = await fetch(`/api/users/${uuid}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            closeModal('edit-user-modal');
            loadUsers();
        } else {
            const err = await response.json();
            alert(err.error || 'Failed to update user');
        }
    } catch (err) {
        alert('Connection error');
    }
    
    submitBtn.disabled = false;
    submitBtn.textContent = 'Save Changes';
    
    return false;
}

async function deleteUser(uuid, username) {
    if (!confirm(`Delete user "${username}"? This action cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/users/${uuid}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadUsers();
            loadStats();
        } else {
            const err = await response.json();
            alert(err.error || 'Failed to delete user');
        }
    } catch (err) {
        alert('Connection error');
    }
}

async function approvePassword(id) {
    try {
        const response = await fetch(`/api/admin/password-requests/${id}/approve`, {
            method: 'POST'
        });
        
        if (response.ok) {
            loadPasswordRequests();
            loadStats();
        } else {
            alert('Failed to approve');
        }
    } catch (err) {
        alert('Connection error');
    }
}

async function rejectPassword(id) {
    if (!confirm('Reject this password change request?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/password-requests/${id}/reject`, {
            method: 'POST'
        });
        
        if (response.ok) {
            loadPasswordRequests();
            loadStats();
        } else {
            alert('Failed to reject');
        }
    } catch (err) {
        alert('Connection error');
    }
}

async function loadForgotRequests() {
    try {
        const response = await fetch('/api/admin/forgot-requests');
        const requests = await response.json();

        const tbody = document.getElementById('forgot-tbody');

        if (requests.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No pending requests</td></tr>';
            return;
        }

        tbody.innerHTML = requests.map(req => `
            <tr>
                <td><strong>${escapeHtml(req.username)}</strong></td>
                <td>${new Date(req.created_at * 1000).toLocaleString()}</td>
                <td>
                    <button onclick="handleForgotRequest(${req.id}, '${escapeHtml(req.username)}')" class="btn btn-sm btn-primary">Set Password</button>
                </td>
            </tr>
        `).join('');
    } catch (err) {
        console.error('Error loading forgot requests:', err);
    }
}

function resetUserPassword(uuid, username) {
    document.getElementById('set-password-title').textContent = `Reset Password — ${username}`;
    document.getElementById('set-password-desc').textContent =
        `Set a temporary password for ${username}. They will be required to change it on next login.`;
    document.getElementById('set-password-target-type').value = 'user';
    document.getElementById('set-password-target-id').value = uuid;
    document.getElementById('set-password-value').value = '';
    showModal('set-password-modal');
}

function handleForgotRequest(id, username) {
    document.getElementById('set-password-title').textContent = `Handle Forgot Password — ${username}`;
    document.getElementById('set-password-desc').textContent =
        `Set a temporary password for ${username}. They will be required to change it on next login.`;
    document.getElementById('set-password-target-type').value = 'forgot';
    document.getElementById('set-password-target-id').value = id;
    document.getElementById('set-password-value').value = '';
    showModal('set-password-modal');
}

async function submitSetPassword(e) {
    e.preventDefault();

    const type = document.getElementById('set-password-target-type').value;
    const targetId = document.getElementById('set-password-target-id').value;
    const newPassword = document.getElementById('set-password-value').value;
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Setting...';

    let url;
    if (type === 'user') {
        url = `/api/admin/users/${targetId}/reset-password`;
    } else {
        url = `/api/admin/forgot-requests/${targetId}/handle`;
    }

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ new_password: newPassword })
        });

        if (response.ok) {
            closeModal('set-password-modal');
            loadUsers();
            loadForgotRequests();
            loadStats();
        } else {
            const err = await response.json();
            alert(err.error || 'Failed to set password');
        }
    } catch (err) {
        alert('Connection error');
    }

    submitBtn.disabled = false;
    submitBtn.textContent = 'Set Password';
    return false;
}

function showGeneratedPassword(username, password) {
    document.getElementById('gen-pass-username').textContent = username;
    document.getElementById('gen-pass-value').textContent = password;
    document.getElementById('copy-gen-pass-btn').textContent = 'Copy';
    showModal('generated-password-modal');
}

function copyGeneratedPassword() {
    const password = document.getElementById('gen-pass-value').textContent;
    navigator.clipboard.writeText(password).then(() => {
        const btn = document.getElementById('copy-gen-pass-btn');
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
    }).catch(() => {
        // Fallback for older browsers
        const el = document.getElementById('gen-pass-value');
        const range = document.createRange();
        range.selectNode(el);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand('copy');
        window.getSelection().removeAllRanges();
        const btn = document.getElementById('copy-gen-pass-btn');
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
    });
}
</script>
