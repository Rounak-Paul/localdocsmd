<div class="dashboard">
    <div class="page-header">
        <div>
            <h1>Dashboard</h1>
            <p class="description">Manage your documentation workspaces</p>
        </div>
        {{#if is_admin}}
        <div class="actions">
            <button onclick="showCreateWorkspace()" class="btn btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 5v14"></path>
                    <path d="M5 12h14"></path>
                </svg>
                New Workspace
            </button>
        </div>
        {{/if}}
    </div>
    
    {{#if password_pending}}
    <div class="alert alert-warning">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"></path>
            <path d="M12 9v4"></path>
            <path d="M12 17h.01"></path>
        </svg>
        <span>Your password change is pending admin approval.</span>
    </div>
    {{/if}}
    
    <div class="section">
        <h2>Your Workspaces</h2>
        <div id="workspaces-list" class="grid">
            <div class="loading">Loading workspaces...</div>
        </div>
    </div>
</div>

<!-- Create Workspace Modal -->
<div id="create-workspace-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create Workspace</h3>
            <button onclick="closeModal('create-workspace-modal')" class="btn-close">&times;</button>
        </div>
        <form onsubmit="return createWorkspace(event)">
            <div class="form-group">
                <label for="ws-name">Workspace Name</label>
                <input type="text" id="ws-name" placeholder="e.g., Engineering Docs" required>
            </div>
            <div class="form-group">
                <label for="ws-description">Description</label>
                <textarea id="ws-description" rows="3" placeholder="Brief description of this workspace..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('create-workspace-modal')" class="btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Workspace</button>
            </div>
        </form>
    </div>
</div>

<!-- Change Password Modal -->
<div id="change-password-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Change Password</h3>
            <button onclick="closeModal('change-password-modal')" class="btn-close">&times;</button>
        </div>
        <form onsubmit="return changePassword(event)">
            <div class="form-group">
                <label for="current-password">Current Password</label>
                <input type="password" id="current-password" placeholder="Enter current password" required>
            </div>
            <div class="form-group">
                <label for="new-password">New Password</label>
                <input type="password" id="new-password" placeholder="Enter new password" required minlength="8">
                <small>Minimum 8 characters</small>
            </div>
            <div class="form-group">
                <label for="confirm-password">Confirm Password</label>
                <input type="password" id="confirm-password" placeholder="Confirm new password" required>
            </div>
            <div id="password-error" class="error-message" style="display: none;"></div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('change-password-modal')" class="btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Password</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadWorkspaces();
    
    // Check if password change is required
    const params = new URLSearchParams(window.location.search);
    if (params.get('change_password') === '1') {
        showModal('change-password-modal');
    }
});

async function loadWorkspaces() {
    try {
        const response = await fetch('/api/workspaces');
        const workspaces = await response.json();
        
        const container = document.getElementById('workspaces-list');
        
        if (workspaces.length === 0) {
            container.innerHTML = `
                <div class="empty-state-box">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.3; margin-bottom: 1rem;">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <p class="empty-state">No workspaces yet</p>
                    <p style="color: var(--text-muted); font-size: 0.875rem;">Create a workspace to get started with your documentation</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = workspaces.map(ws => `
            <div class="card" onclick="window.location='/workspace/${ws.uuid}'">
                <div class="card-header">
                    <h3>${escapeHtml(ws.name)}</h3>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.4;">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </div>
                <div class="card-body">
                    <p>${escapeHtml(ws.description || 'No description')}</p>
                </div>
            </div>
        `).join('');
    } catch (err) {
        console.error('Error loading workspaces:', err);
        document.getElementById('workspaces-list').innerHTML = '<p class="empty-state">Error loading workspaces</p>';
    }
}

function showCreateWorkspace() {
    showModal('create-workspace-modal');
}

async function createWorkspace(e) {
    e.preventDefault();
    
    const name = document.getElementById('ws-name').value;
    const description = document.getElementById('ws-description').value;
    const submitBtn = e.target.querySelector('button[type="submit"]');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating...';
    
    try {
        const response = await fetch('/api/workspaces', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description })
        });
        
        if (response.ok) {
            closeModal('create-workspace-modal');
            loadWorkspaces();
            e.target.reset();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to create workspace');
        }
    } catch (err) {
        alert('Connection error');
    }
    
    submitBtn.disabled = false;
    submitBtn.textContent = 'Create Workspace';
    
    return false;
}

async function changePassword(e) {
    e.preventDefault();
    
    const current = document.getElementById('current-password').value;
    const newPass = document.getElementById('new-password').value;
    const confirm = document.getElementById('confirm-password').value;
    const errorDiv = document.getElementById('password-error');
    
    if (newPass !== confirm) {
        errorDiv.textContent = 'Passwords do not match';
        errorDiv.style.display = 'block';
        return false;
    }
    
    try {
        const response = await fetch('/api/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                current_password: current, 
                new_password: newPass 
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert(data.message || 'Password changed successfully');
            closeModal('change-password-modal');
            window.location.href = '/dashboard';
        } else {
            errorDiv.textContent = data.error || 'Failed to change password';
            errorDiv.style.display = 'block';
        }
    } catch (err) {
        errorDiv.textContent = 'Connection error';
        errorDiv.style.display = 'block';
    }
    
    return false;
}
</script>

<style>
.empty-state-box {
    grid-column: 1 / -1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-2xl);
    background: var(--card-bg);
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-lg);
    text-align: center;
}
</style>
